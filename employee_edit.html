{% extends 'authentication/base.html' %}
{% load static %}

{% block content %}
<style>
  /* make sure select wrapper doesn't constrain width */
  .select-wrapper { width: 100%; display: block; }

  /* ensure the original select keeps full width (helps Select2 measurement) */
  select.form-control { width: 100%; }

  /* force Select2 container to be full width of its parent */
  .select2-container { width: 100% !important; box-sizing: border-box; }

  /* Some theme-specific tweaks for default Select2 single height/appearance */
  .select2-container--default .select2-selection--single {
    padding: 6px 10px;
    
    min-height: 38px;
    box-sizing: border-box;
  }
  .select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 28px;
    padding-right: 24px;
  }

  /* avoid applying native .form-control styles to generated Select2 DOM */
  select.form-control:not(.select2-hidden-accessible),
  input.form-control,
  textarea.form-control {
    /* preserve your rules for real controls */
  }
</style>
<style>
  /* --- Make Select2 fields a little taller (single & multiple) --- */

/* Single-select (default theme) */
.select2-container--default .select2-selection--single {
  height: 36px;                /* total control height */
  padding: 4px 2px;          /* inner spacing */
        /* match your form-control rounded corners */
  box-sizing: border-box;
}

/* Rendered text should be vertically centered */
.select2-container--default .select2-selection--single .select2-selection__rendered {
  line-height: 28px;          /* adjust so text is centered within height */
  margin-top: 0;
  padding-right: 24px;        /* keep room for arrow */
}

/* Arrow area must match height to vertically center the caret */
.select2-container--default .select2-selection--single .select2-selection__arrow {
  height: 46px;
  top: 0;
  right: 10px;
}

/* Multiple-select: give a minimum height and nicer padding for tags */
.select2-container--default .select2-selection--multiple {
  min-height: 46px;
  padding: 6px 8px;
  border-radius: 10px;
  box-sizing: border-box;
}

/* Inline search input inside multiple select (typeable area) */
.select2-container--default .select2-selection--multiple .select2-search--inline .select2-search__field {
  height: 28px;        /* input height inside the multiple select */
  margin-top: 6px;
  box-sizing: border-box;
}

/* Tweak tag alignment inside multiple select */
.select2-container--default .select2-selection--multiple .select2-selection__choice {
  line-height: 20px;
  height: auto;
  padding: 4px 8px;
  margin-top: 4px;
}

/* Prevent your broad .form-control rule from accidentally styling the Select2 generated DOM.
   This makes sure only native selects (not Select2's hidden original) get the form-control styles. */
input.form-control,
textarea.form-control,
select.form-control:not(.select2-hidden-accessible) {
  /* keep your existing rules here (or none) */
}

/* Optional: smaller screens (adjust if needed) */
@media (max-width: 480px) {
  .select2-container--default .select2-selection--single,
  .select2-container--default .select2-selection--multiple {
    height: 44px;
  }
  .select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 30px;
  }
}

</style>
<style>
  :root {
    --teal: #0ea5a3;
    --muted: #6b7280;
    --surface: #fff;
    --danger: #ef4444;
  }
  body {
    font-family: Inter, "Open Sans", Arial, sans-serif;
    background: #f6fbfb;
    margin: 0;
  }
  #page-wrapper {
    min-height: 100vh;
  }

  /* Card */
  .card-centered {
    max-width: 100%;
    margin: 20px auto;
    background: var(--surface);
    border-radius: 12px;
    box-shadow: 0 12px 30px rgba(2, 6, 23, 0.06);
    overflow: hidden;
  }
  .card-body {
    display: flex;
    flex-direction: column;
    gap: 18px;
    padding: 18px;
  }
  @media (min-width: 920px) {
    .card-body {
      flex-direction: row;
    }
  }

  /* left form and right avatar */
  .form-col {
    flex: 1;
    padding-right: 10px;
  }
  /* Reduced avatar column width to keep sidebar visible */
  .avatar-col {
    flex: 0 0 240px;
    padding-left: 14px;
    border-left: 2px solid rgba(2, 6, 23, 0.04);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  @media (min-width: 720px) {
    .form-grid:not(.top-section-grid) {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* Specific grid for top section - always 12 columns */
  .top-section-grid {
    grid-template-columns: repeat(12, 1fr) !important;
  }

  /* Ensure grid-column spans work properly in top-section-grid */
  .top-section-grid .form-group[style*="grid-column: span"] {
    /* Respect inline grid-column span values */
    min-width: 0;
    width: auto;
  }

  /* Override any width: 100% rules for form-groups in top-section-grid */
  .top-section-grid .form-group {
    width: auto;
    max-width: 100%;
  }

  /* Responsive adjustments for top-section-grid on smaller screens */
  @media (max-width: 767px) {
    .top-section-grid {
      grid-template-columns: repeat(1, 1fr) !important;
    }
    .top-section-grid .form-group[style*="grid-column: span"] {
      grid-column: 1 / -1 !important;
    }
  }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 700;
      color: var(--muted);
      margin-bottom: 6px;
      font-size: 13px;
    }
    .form-control {
      padding: 10px 12px;
      border-radius: 2px;
      border: 1px solid #e6eef0;
      background: #fbfdfe;
    }
    .form-control:focus {
      outline: none;
      box-shadow: 0 8px 24px rgba(14, 165, 163, 0.08);
      border-color: var(--teal);
    }

  .col-span-3 {
    grid-column: 1 / -1;
  }

  .tabs {
    display: flex;
    gap: 8px;
    border-bottom: 0;
    margin-bottom: 14px;
  }
  .tab-btn {
    background: #f8fafb;
    border: 1px solid #e6eef0;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 700;
    color: var(--muted);
  }
  .tab-btn.active {
    background: linear-gradient(
      180deg,
      rgba(14, 165, 163, 0.1),
      rgba(14, 165, 163, 0.04)
    );
    color: var(--teal);
    box-shadow: 0 4px 10px rgba(14, 165, 163, 0.06);
  }
  /* Tab — make error state a clear solid red with white text */
  .tab-btn.error {
    color: var(--danger) !important; /* only change text color to red */
    border-color: transparent !important;
    box-shadow: none !important;
    filter: none !important;
    /* border: 1px solid var(--danger) !important; */
    background: linear-gradient(
      180deg,
      rgba(165, 14, 14, 0.1),
      rgba(165, 14, 14, 0.04)
    );
  }

  /* Slightly darker hover for red tab for affordance */
  .tab-btn.error:hover {
    background: linear-gradient(
      180deg,
      rgba(253, 172, 172, 0.1),
      rgba(250, 173, 173, 0.04)
    );
    filter: brightness(0.95);
  }

  .actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 14px;
  }

  

  /* avatar: preview ~120-140px */
  .avatar-wrap {
    width: 140px;
    height: 140px;
    border-radius: 999px;
    overflow: hidden;
    border: 6px solid #f3f3f3;
    box-shadow: 0 14px 40px rgba(2, 6, 23, 0.08);
    display: grid;
    place-items: center;
    background: linear-gradient(180deg, #f8fafb, #fff);
  }
  .avatar-wrap img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .avatar-text {
    color: var(--muted);
    font-size: 13px;
    text-align: center;
  }
  .avatar-actions {
    margin-top: 12px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .btn-upload {
    margin-top: 7px;
    /* background: var(--teal); */
    color: #fff;
    padding: 7px 9px;
    border-radius: 8px;
    border: 0;
  }
  .btn-clear {
    background: #ebe9e9;
    border: 1px solid rgba(2, 6, 23, 0.06);
    padding: 7px 9px;
    border-radius: 8px;
  }

  .field-error {
    color: var(--danger);
    font-size: 12px;
    margin-top: 6px;
    display: none;
  }
  .is-invalid {
    border-color: var(--danger) !important;
    box-shadow: none !important;
    outline: none !important;
    background-image: none !important;
    background-repeat: no-repeat !important;
    background-position: right center !important;
  }
  .hidden {
    display: none !important;
  }

  .password-toggle {
    position: absolute;
    right: 12px;
    top: 36px;
    background: transparent;
    border: 0;
    color: var(--muted);
    cursor: pointer;
  }
  .relative {
    position: relative;
  }

  @media (max-width: 720px) {
    .avatar-col {
      border-left: none;
      border-top: 1px solid rgba(2, 6, 23, 0.04);
      padding-top: 12px;
    }
  }
  .section-title {
    font-size: 14px;
    font-weight: 800;
    margin: 6px 0 12px;
    color: #0f172a;
  }
  .hint {
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
  }

  /* ===== Custom select styling: full area, consistent arrow ===== */

</style>

<style>
  /* ensure server/client-side error nodes are visible */
  .field-error, small.validate-error {
    display: block !important;
    color: #c82333;
    margin-top: .25rem;
    font-size: 0.6rem;
  }

    /* ===== Custom select styling: full area, consistent arrow ===== */
.select2-container--default .select2-selection--multiple .select2-search--inline .select2-search__field {
    height: 19px;
    margin-top: 6px;
    box-sizing: border-box;
}
.select2-container--default .select2-selection--multiple {

    border-radius: 5px;
   
}
</style>

<style>
.selectize-dropdown .option.active {
  background: rgba(0,0,0,0.65) !important;
  color: #fff !important;
  font-weight: 600;
  transition: none !important;
}
.select-wrapper {
  text-align: left;  /* or remove text-align entirely */
}
.selectize-dropdown-emptyoptionlabel{
  text-align: left;
}
</style>

<style>
  .form-label {
    font-weight: 600;
    color: #2b2f36;
    margin-bottom: 6px;
    display: block;
  }

  .photo-card {
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    background: linear-gradient(180deg, #fbfdff, #ffffff);
    border: 1px dashed #e6eef6;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: 200px;
    height: auto;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
  }

  .img-wrap {
    width: 100%;
    max-width: 160px;
    height: 140px;
    border-radius: 8px;
    overflow: hidden;
    background: #fafbfd;
    border: 1px solid #eef3f7;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-sizing: border-box;
    margin: 0 auto;
  }

  .img-wrap img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .image-placeholder {
    padding: 12px;
    color: #98a0aa;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    text-align: center;
  }

  .avatar-actions {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
  }

  .btn-upload,
  .btn-clear {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
  }

  .btn-upload {
    background-color: #1ab394;
    color: white;
  }

  .btn-clear {
    background-color: #dc3545;
    color: white;
  }

  .hint {
    font-size: 12px;
    color: #6c757d;
    margin-top: 8px;
    text-align: center;
  }

  .hidden {
    display: none;
  }
</style>


<div class="row wrapper border-bottom white-bg page-heading">
  <div class="col-lg-10">
    <h2>Employee</h2>
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a class="voucher-link" href="{% url 'authentication:dashboard' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'employee:employee_list' %}?q={{ query|urlencode }}&items_per_page={{ items_per_page }}&page={{ page_obj.number }}">Employee List</a></li>

      <li class="breadcrumb-item active"><strong>Update</strong></li>
    </ol>
  </div>
  <div class="col-lg-2"></div>
</div>
<div class="wrapper wrapper-content">
  <div class="card-centered" role="region" aria-label="Edit employee">
    <div class="card-body">

      <style>
        /* Top / bottom split: top has left inputs and right avatar, bottom holds the tabs + panels */
        .top-section {
          display: grid;
          grid-template-columns: 1fr 320px; /* left content + avatar */
          gap: 20px;
          align-items: start;
        }

        .top-left { }

        .top-right {
          width: 320px;
          max-width: 320px;
          margin-top: 70px;
        }

        
      </style>

      <!-- LEFT: Form -->
      <div class="form-col">
        <form id="employeeForm" method="post" enctype="multipart/form-data" novalidate>
          {% csrf_token %}

          {# show non-field error if present - use non_field_errors variable provided by view #}
          {% if non_field_errors %}
            <div class="alert alert-danger">{{ non_field_errors }}</div>
          {% endif %}

          <!-- TOP SECTION: left inputs + right avatar (one div) -->
          <div class="top-section" aria-label="Top section: basic info & avatar">
            <!-- left: top inputs -->
            <div class="top-left">
              <div class="form-grid top-section-grid" style="grid-template-columns: repeat(12, 1fr);">

                <div class="form-group" style="grid-column: span 4;">
                  <label for="name">Full Name  <span class="text-danger">*</span></label>
                  <input id="name" name="name"
                         class="form-control {% if errors.name or errors.employeeName %}is-invalid{% endif %} string-only"
                         value="{{ employee_data.employee_name|default:posted.name|default:'' }}" autofocus tabindex="1"/>
                  <div class="field-error" data-error-for="name">
                    {% if errors.name %}
                      {{ errors.name }}
                    {% elif errors.employeeName %}
                      {{ errors.employeeName }}
                    {% elif field_errors.name %}
                      {{ field_errors.name }}
                    {% elif field_errors.employeeName %}
                      {{ field_errors.employeeName }}
                    {% endif %}
                  </div>
                </div>

                <div class="form-group" style="grid-column: span 4;">
                  <label for="email">Email </label>
                  <input id="email" name="email" type="email"
                         class="form-control {% if errors.email or errors.Email %}is-invalid{% endif %}"
                         value="{{ employee_data.email|default:posted.email|default:'' }}" tabindex="2" />
                  <div class="field-error" data-error-for="email">
                    {% if errors.email %}
                      {{ errors.email }}
                    {% elif errors.Email %}
                      {{ errors.Email }}
                    {% elif field_errors.email %}
                      {{ field_errors.email }}
                    {% elif field_errors.Email %}
                      {{ field_errors.Email }}
                    {% endif %}
                  </div>
                </div>

                <div class="form-group" style="grid-column: span 4;">
                  <label for="mobile">Mobile  <span class="text-danger">*</span></label>
                  <input id="mobile" name="mobile"
                         class="form-control {% if errors.mobile or errors.personal_mobile %}is-invalid{% endif %} only-number"
                         value="{{ employee_data.personal_mobile|default:posted.mobile|default:'' }}" tabindex="3" />
                  <div class="field-error" data-error-for="mobile">
                    {% if errors.mobile %}
                      {{ errors.mobile }}
                    {% elif errors.personal_mobile %}
                      {{ errors.personal_mobile }}
                    {% elif field_errors.mobile %}
                      {{ field_errors.mobile }}
                    {% endif %}
                  </div>
                </div>

              <div class="form-group" style="grid-column: span 4;">
                <label for="gender">Gender  <span class="text-danger">*</span></label>
                <div class="select-wrapper" aria-hidden="false">
                  <select id="gender" name="gender" class="{% if errors.gender %}is-invalid{% endif %}" tabindex="4">
          <option value="" selected disabled hidden></option>
                    <option value="male" {% if employee_data.gender == 'male' or posted.gender == 'male' %}selected{% endif %}>Male</option>
                    <option value="female" {% if employee_data.gender == 'female' or posted.gender == 'female' %}selected{% endif %}>Female</option>
                    <option value="other" {% if employee_data.gender == 'other' or posted.gender == 'other' %}selected{% endif %}>Other</option>
                  </select>
                </div>
                <div class="field-error" data-error-for="gender">
                  {% if errors.gender %}{{ errors.gender }}{% elif field_errors.gender %}{{ field_errors.gender }}{% endif %}
                </div>
              </div>

<div class="form-group d-none">
  <label for="lco" class="font-weight-bold">LCO  <span class="text-danger">*</span></label>
  <select name="lco" id="lco"
          class="{% if errors.lco %}is-invalid{% endif %}"
          {% if disable_lco_select %}disabled{% endif %}
         >
          <option value="" selected disabled hidden></option>
    {% for l in lco_choices %}
      <option value="{{ l.id }}"
              {% if l.id|stringformat:"s" == lco|stringformat:"s" or l.id|stringformat:"s" == selected_lco_id|stringformat:"s" %}
                selected
              {% endif %}>
        {{ l.name }}{% if l.code %} ({{ l.code }}){% endif %}
      </option>
    {% endfor %}
  </select>

  {% if disable_lco_select %}
    <!-- Preserve value if LCO select is disabled -->
    <input type="hidden" name="lco" value="{{ selected_lco_id }}">
  {% endif %}

  <div class="invalid-feedback field-error" data-error-for="lco">
    {% if errors.lco %}{{ errors.lco }}{% elif field_errors.lco %}{{ field_errors.lco }}{% endif %}
  </div>
</div>



                <div class="form-group" style="grid-column: span 8;">
                  <label for="branch">Branch</label>
                  <div class="select-wrapper">
                  <select id="branch" name="branch_id" class="{% if errors.branch %}is-invalid{% endif %}" tabindex="5">
                    <option value="" selected disabled hidden ></option>
                    {% for b in branches %}
                      <option value="{{ b.id }}"
                        {% if b.id|stringformat:"s" == employee_data.branch_id|stringformat:"s" or b.id|stringformat:"s" == posted.branch_id|stringformat:"s" %}
                          selected
                        {% endif %}>
                        {{ b.name }}
                      </option>
                    {% endfor %}
                  </select>

                  </div>
                  <div class="field-error" data-error-for="branch">
                    {% if errors.branch %}
                      {{ errors.branch }}
                    {% elif field_errors.branch %}
                      {{ field_errors.branch }}
                    {% endif %}
                  </div>
                </div>


<!-- Allowed branches (full width of top-left) -->
<div class="form-group full-row" style="grid-column: 1 / -1;">
  <label for="allowed_branches">Allowed Branches</label>
  <div class="select-wrapper" aria-hidden="false">
    <select id="allowed_branches"
            name="allowed_branches"
            class="{% if errors.allowed_branches %}is-invalid{% endif %}"
            multiple
            data-placeholder="Select allowed branches" tabindex="6">
      {% for b in branches %}
        {% with bval=b.id|stringformat:"s" %}
          <option value="{{ b.id }}"
            {% if posted.allowed_branches %}
              {% if bval in posted.allowed_branches %}selected{% endif %}
            {% elif employee_data.allowed_branches %}
              {% if bval in employee_data.allowed_branches or b.id in employee_data.allowed_branches %}selected{% endif %}
            {% endif %}>
            {{ b.name }}
          </option>
        {% endwith %}
      {% endfor %}
    </select>
  </div>

  <small class="form-text text-muted">Choose one or more branches the employee is allowed to access.</small>
  <div class="field-error" data-error-for="allowed_branches">
    {% if errors.allowed_branches %}{{ errors.allowed_branches }}{% elif field_errors.allowed_branches %}{{ field_errors.allowed_branches }}{% endif %}
  </div>
</div>


              </div> <!-- /.form-grid top-left -->
            </div> <!-- /.top-left -->

            <!-- right: avatar -->
<div>
  <div>
<div class="photo-card mx-auto">
  <label class="form-label mb-2">Profile Photo</label>

  <input type="hidden" id="remove_image" name="remove_image" value="0" />
  <input type="file" id="employee-image-upload" name="image" accept="image/*" class="hidden" />

  <!-- Image/placeholder -->
  <div class="img-wrap">
    <img id="previewImg"
         {% if not employee_data.photo_url %}class="hidden"{% endif %}
         src="{% if employee_data.photo_url %}{{ employee_data.photo_url }}{% else %}#{% endif %}"
         alt="Profile preview"
    />
    <div id="avatarText" class="image-placeholder" {% if employee_data.photo_url %}style="display:none"{% endif %}>
      <div style="font-size:16px; font-weight:600;">No image</div>
      <div class="help-muted">Upload JPG/PNG ≤ 2MB</div>
    </div>
  </div>

  <!-- Action buttons -->
  <div class="avatar-actions">
    <label class="btn-upload" for="employee-image-upload">Choose</label>
    <button id="removeImageBtn" type="button" class="btn-clear">Remove</button>
  </div>

  <!-- <p class="hint">PNG, JPG, WEBP • Max 2MB</p> -->
</div>
</div>
<div class="form-check mt-3 text-center">
    <input class="form-check-input" type="checkbox" value="1" id="id_is_active" name="is_active" {% if employee_data.is_active %}checked{% endif %}>
    <label class="form-check-label" for="id_is_active">
        Active
    </label>
</div>

</div>





          </div> <!-- /.top-section -->

          <!-- BOTTOM SECTION: tabs + panels (spans full width) -->
          <div class="bottom-section" aria-label="Tabs and detailed panels">
  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="Employee sections">
    <button type="button" id="tab-working" class="tab-btn active" aria-controls="panel-working">Working Info</button>
    <button type="button" id="tab-salary" class="tab-btn" aria-controls="panel-salary">Salary</button>
    <button type="button" id="tab-personal" class="tab-btn" aria-controls="panel-personal">Personal Info</button>
    <button type="button" id="tab-login" class="tab-btn" aria-controls="panel-login">Login Info</button>
  </div>

  <!-- WORKING -->
  <div id="panel-working" class="panel-section">
    <h3 class="section-title">Work Details</h3>
    <div class="form-grid three-col" style="grid-template-columns: repeat(3, 1fr)">

<div class="form-group">
  <label for="position">Position <span class="text-danger">*</span></label>
  <div class="select-wrapper">
    <select id="position" name="position" class="{% if errors.position %}is-invalid{% endif %}" tabindex="7" required>
          <option value="" selected disabled hidden></option>
      <!-- CREATE sentinel -->
      <option value="__create_position__">+ Create|Edit position</option>
      {% for p in job_positions %}
        <option value="{{ p.id }}"
          {% if p.id|stringformat:"s" == employee_data.position_id|stringformat:"s" or p.id|stringformat:"s" == posted.position|stringformat:"s" %}
            selected
          {% endif %}
        >
          {{ p.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="field-error" data-error-for="position">
    {% if errors.position %}{{ errors.position }}{% elif field_errors.position %}{{ field_errors.position }}{% endif %}
  </div>
</div>
<div class="form-group">
  <label for="department">Department  <span class="text-danger">*</span></label>
  <div class="select-wrapper">
    <select id="department" name="department" class="{% if errors.department %}is-invalid{% endif %}" tabindex="8" required>
          <option value="" selected disabled hidden></option>
      <!-- CREATE sentinel -->
      <option value="__create_department__">+ Create|Edit department</option>
      {% for d in departments %}
        <option value="{{ d.id }}"
          {% if d.id|stringformat:"s" == employee_data.department_id|stringformat:"s" or d.id|stringformat:"s" == posted.department|stringformat:"s" %}
            selected
          {% endif %}
        >
          {{ d.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="field-error" data-error-for="department">
    {% if errors.department %}{{ errors.department }}{% elif field_errors.department %}{{ field_errors.department }}{% endif %}
  </div>
</div>


<div class="form-group">
  <label for="manager">Manager</label>
  <div class="select-wrapper">
    <select id="manager" name="manager_id" class="{% if errors.manager %}is-invalid{% endif %}" tabindex="9">
      <option value="" ></option>
      {% for m in managers %}
        <option value="{{ m.id }}"
          {% if m.id|stringformat:"s" == employee_data.manager_id|stringformat:"s" or m.id|stringformat:"s" == posted.manager_id|stringformat:"s" %}
            selected
          {% endif %}>
          {{ m.employee_name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="field-error" data-error-for="manager">
    {% if errors.manager %}{{ errors.manager }}{% elif field_errors.manager %}{{ field_errors.manager }}{% endif %}
  </div>
</div>
      <div class="form-group">
        <label for="employeeId">Employee ID  <span class="text-danger">*</span></label>
        <input id="employeeId" name="employeeId"
               class="form-control {% if errors.employee_id or errors.employeeId %}is-invalid{% endif %}"
               value="{{ employee_data.employee_id|default:posted.employeeId|default:'' }}"  tabindex="10"/>
        <div class="field-error" data-error-for="employeeId">
          {% if errors.employeeId %}
            {{ errors.employeeId }}
          {% elif errors.employee_id %}
            {{ errors.employee_id }}
          {% elif field_errors.employeeId %}
            {{ field_errors.employeeId }}
          {% elif field_errors.employee_id %}
            {{ field_errors.employee_id }}
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="workEmail">Work Email </label>
        <input id="workEmail" name="workEmail" type="email"
               class="form-control {% if errors.workEmail or errors.work_email %}is-invalid{% endif %}"
               value="{{ employee_data.work_email|default:posted.workEmail|default:'' }}" tabindex="11" />
        <div class="field-error" data-error-for="workEmail">
          {% if errors.workEmail %}{{ errors.workEmail }}{% elif errors.work_email %}{{ errors.work_email }}{% elif field_errors.workEmail %}{{ field_errors.workEmail }}{% elif field_errors.work_email %}{{ field_errors.work_email }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="workMobile">Work Mobile </label>
        <input id="workMobile" name="workMobile"
               class="form-control {% if errors.workMobile %}is-invalid{% endif %} only-number"
               value="{{ employee_data.work_mobile|default:posted.workMobile|default:'' }}" maxlength="10" tabindex="12"/>
        <div class="field-error" data-error-for="workMobile">
          {% if errors.workMobile %}{{ errors.workMobile }}{% elif field_errors.workMobile %}{{ field_errors.workMobile }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="workPhone">Work Phone </label>
        <input id="workPhone" name="workPhone"
               class="form-control {% if errors.workPhone %}is-invalid{% endif %} only-number"
               value="{{ employee_data.work_phone|default:posted.workPhone|default:'' }}" maxlength="10" tabindex="13"/>
        <div class="field-error" data-error-for="workPhone">
          {% if errors.workPhone %}{{ errors.workPhone }}{% elif field_errors.workPhone %}{{ field_errors.workPhone }}{% endif %}
        </div>
      </div>



      <div class="form-group">
        <label for="workLocation">Work Location </label>
        <input id="workLocation" name="workLocation"
               class="form-control {% if errors.workLocation %}is-invalid{% endif %}"
               value="{{ employee_data.work_location|default:posted.workLocation|default:'' }}" tabindex="14"/>
        <div class="field-error" data-error-for="workLocation">
          {% if errors.workLocation %}{{ errors.workLocation }}{% elif field_errors.workLocation %}{{ field_errors.workLocation }}{% endif %}
        </div>
      </div>

      <div class="form-group d-none">
        <label for="visaNumber">Visa Number</label>
        <input id="visaNumber" name="visaNumber" class="form-control"
               value="{{ employee_data.visa_number|default:posted.visaNumber|default:'' }}" />
      </div>

      <div class="form-group d-none">
        <label for="workPermitNumber">Work permit No</label>
        <input id="workPermitNumber" name="workPermitNumber" class="form-control"
               value="{{ employee_data.work_permit|default:posted.workPermitNumber|default:'' }}" />
      </div>

      <div class="form-group d-none">
        <label for="visaExpDate">Visa Expiry Date</label>
        <input id="visaExpDate" name="visaExpDate" type="date" class="form-control"
               value="{{ employee_data.visa_expiry_date|default:posted.visaExpDate|default:'' }}" />
      </div>

    </div> <!-- /.form-grid working -->
  </div> <!-- /.panel-working -->

  <!-- SALARY -->
  <div id="panel-salary" class="panel-section" style="display:none;">
    <h3 class="section-title">Salary</h3>
    <div class="form-grid three-col" style="grid-template-columns: repeat(3, 1fr)">

      <div class="form-group">
        <label for="basicSalary">Basic Salary </label>
        <input id="basicSalary" name="basicSalary" type="number" step="0.01" min="0"
               class="form-control {% if errors.basicSalary %}is-invalid{% endif %} decimal-number"
               value="{{ employee_data.basic_salary|default:posted.basicSalary|default:'' }}" style="text-align: right;" tabindex="15"/>
        <div class="field-error" data-error-for="basicSalary">
          {% if errors.basicSalary %}{{ errors.basicSalary }}{% elif field_errors.basicSalary %}{{ field_errors.basicSalary }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="da">DA (Dearness Allowance) </label>
        <input id="da" name="da" type="number" step="0.01" min="0"
               class="form-control {% if errors.da %}is-invalid{% endif %} decimal-number"
               value="{{ employee_data.da|default:posted.da|default:'' }}" style="text-align: right;" tabindex="16" />
        <div class="field-error" data-error-for="da">
          {% if errors.da %}{{ errors.da }}{% elif field_errors.da %}{{ field_errors.da }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="hra">HRA (House Rent Allowance) </label>
        <input id="hra" name="hra" type="number" step="0.01" min="0"
               class="form-control {% if errors.hra %}is-invalid{% endif %} decimal-number"
               value="{{ employee_data.hra|default:posted.hra|default:'' }}" style="text-align: right;" tabindex="17"/>
        <div class="field-error" data-error-for="hra">
          {% if errors.hra %}{{ errors.hra }}{% elif field_errors.hra %}{{ field_errors.hra }}{% endif %}
        </div>
      </div>

    </div> <!-- /.form-grid salary -->
  </div> <!-- /.panel-salary -->

  <!-- PERSONAL -->
  <div id="panel-personal" class="panel-section" style="display:none;">
    <h3 class="section-title">Personal Information</h3>
    <div class="form-grid three-col" style="grid-template-columns: repeat(3, 1fr)">

      <div class="form-group">
        <label for="address">Address </label>
        <input id="address" name="address" class="form-control {% if errors.address %}is-invalid{% endif %}"
               value="{{ employee_data.address_line1|default:posted.address|default:'' }}" tabindex="18" />
        <div class="field-error" data-error-for="address">
          {% if errors.address %}{{ errors.address }}{% elif field_errors.address %}{{ field_errors.address }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="dateOfBirth">Date of Birth </label>
        <input id="dateOfBirth" name="dateOfBirth" type="date" class="form-control {% if errors.dateOfBirth %}is-invalid{% endif %}"
               value="{{ employee_data.date_of_birth|default:posted.dateOfBirth|default:'' }}" tabindex="19" />
        <div class="field-error" data-error-for="dateOfBirth">
          {% if errors.dateOfBirth %}{{ errors.dateOfBirth }}{% elif field_errors.dateOfBirth %}{{ field_errors.dateOfBirth }}{% endif %}
        </div>
      </div>

<div class="form-group">
  <label for="maritalStatus">Marital Status</label>
  <div class="select-wrapper">
    <select id="maritalStatus" name="maritalStatus"
            class="selectize-marital {% if errors.maritalStatus %}is-invalid{% endif %}" tabindex="20">
          <option value="" selected disabled hidden></option>
      <option value="__create_marital_status__">+ Add More</option>

      {% for status in marital_statuses %}
        <option value="{{ status.id }}"
          {% if status.id|stringformat:"s" == employee_data.marital_status|stringformat:"s" or status.id|stringformat:"s" == posted.maritalStatus|stringformat:"s" %} selected {% endif %}
        >{{ status.name }} </option>
      {% endfor %}
    </select>
  </div>
  <div class="field-error" data-error-for="maritalStatus">
    {% if errors.maritalStatus %}{{ errors.maritalStatus }}{% elif field_errors.maritalStatus %}{{ field_errors.maritalStatus }}{% endif %}
  </div>
</div>

<div class="form-group">
  <label for="country">Country </label>
  <div class="select-wrapper">
    <select id="country" name="country" class="{% if errors.country %}is-invalid{% endif %}" data-placeholder="Select Country" data-selected="{{ employee_data.country|default:posted.country|default:'' }}" tabindex="21">
      <option value="">Select Country</option>
      {% if employee_data.country %}
        <option value="{{ employee_data.country }}" selected>{{ employee_data.country }}</option>
      {% elif posted.country %}
        <option value="{{ posted.country }}" selected>{{ posted.country }}</option>
      {% endif %}
    </select>
  </div>
  <div class="field-error" data-error-for="country">
    {% if errors.country %}{{ errors.country }}{% elif field_errors.country %}{{ field_errors.country }}{% endif %}
  </div>
</div>


      <div class="form-group">
        <label for="state">State</label>
        <div class="select-wrapper">
          <select id="state" name="state" class="{% if errors.state %}is-invalid{% endif %}" data-placeholder="Select State" data-selected="{{ employee_data.state|default:posted.state|default:'' }}" tabindex="22">
            <option value="">Select State</option>
            {% if employee_data.state %}
              <option value="{{ employee_data.state }}" selected>{{ employee_data.state }}</option>
            {% elif posted.state %}
              <option value="{{ posted.state }}" selected>{{ posted.state }}</option>
            {% endif %}
          </select>
        </div>
        <div class="field-error" data-error-for="state">
          {% if errors.state %}{{ errors.state }}{% elif field_errors.state %}{{ field_errors.state }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="district">District </label>
        <div class="select-wrapper">
          <select id="district" name="district" class="{% if errors.district %}is-invalid{% endif %}" data-placeholder="Select District" data-selected="{{ employee_data.district|default:posted.district|default:'' }}" tabindex="23">
            <option value="">Select District</option>
            {% if employee_data.district %}
              <option value="{{ employee_data.district }}" selected>{{ employee_data.district }}</option>
            {% elif posted.district %}
              <option value="{{ posted.district }}" selected>{{ posted.district }}</option>
            {% endif %}
          </select>
        </div>
        <div class="field-error" data-error-for="district">
          {% if errors.district %}{{ errors.district }}{% elif field_errors.district %}{{ field_errors.district }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="city">City </label>
        <input id="city" name="city" class="form-control {% if errors.city %}is-invalid{% endif %}"
               value="{{ employee_data.city|default:posted.city|default:'' }}" tabindex="24" />
        <div class="field-error" data-error-for="city">
          {% if errors.city %}{{ errors.city }}{% elif field_errors.city %}{{ field_errors.city }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="pinCode">Pin Code </label>
        <input id="pinCode" name="pinCode" class="form-control {% if errors.pinCode %}is-invalid{% endif %} only-number"
               value="{{ employee_data.pincode|default:posted.pinCode|default:'' }}" maxlength="6" tabindex="25" />
        <div class="field-error" data-error-for="pinCode">
          {% if errors.pinCode %}{{ errors.pinCode }}{% elif field_errors.pinCode %}{{ field_errors.pinCode }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="aadhaarNumber">Aadhaar Number</label>
        <input id="aadhaarNumber" name="aadhaarNumber" class="form-control {% if errors.aadhaarNumber %}is-invalid{% endif %} only-number"
               inputmode="numeric" maxlength="12" pattern="\d{12}"
               value="{{ employee_data.aadhaar_number|default:posted.aadhaarNumber|default:'' }}" tabindex="26" />
        <div class="field-error" data-error-for="aadhaarNumber">
          {% if errors.aadhaarNumber %}{{ errors.aadhaarNumber }}{% elif field_errors.aadhaarNumber %}{{ field_errors.aadhaarNumber }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="passportNumber">Passport No</label>
        <input id="passportNumber" name="passportNumber" class="form-control {% if errors.passportNumber %}is-invalid{% endif %}"
               value="{{ employee_data.passport_number|default:posted.passportNumber|default:'' }}" tabindex="27" />
        <div class="field-error" data-error-for="passportNumber">
          {% if errors.passportNumber %}{{ errors.passportNumber }}{% elif field_errors.passportNumber %}{{ field_errors.passportNumber }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="numberOfChildren">Number of Children</label>
        <input id="numberOfChildren" name="numberOfChildren" class="form-control {% if errors.numberOfChildren %}is-invalid{% endif %} only-number"
               value="{{ employee_data.number_of_children|default:posted.numberOfChildren|default:'' }}" tabindex="28" />
        <div class="field-error" data-error-for="numberOfChildren">
          {% if errors.numberOfChildren %}{{ errors.numberOfChildren }}{% elif field_errors.numberOfChildren %}{{ field_errors.numberOfChildren }}{% endif %}
        </div>
      </div>

      <div class="form-group">
        <label for="emgContactName">Emergency Contact Name</label>
        <input id="emgContactName" name="emgContactName" class="form-control string-only"
               value="{{ employee_data.emergency_contact_name|default:posted.emgContactName|default:'' }}" tabindex="29" />
      </div>

      <div class="form-group">
        <label for="emgPhone">Emergency Phone</label>
        <input id="emgPhone" name="emgPhone" class="form-control only-number"
               value="{{ employee_data.emergency_contact|default:posted.emgPhone|default:'' }}" maxlength="10" tabindex="30" />
      </div>

    </div> <!-- /.form-grid personal -->
  </div> <!-- /.panel-personal -->

  <!-- LOGIN -->
  <div id="panel-login" class="panel-section" style="display:none;">
    <h3 class="section-title">Login</h3>
    <div class="form-grid three-col" style="grid-template-columns: repeat(3, 1fr); gap:12px;">
      
  <!-- Type (select) -->
  <div class="form-group relative">
  <label for="employee_type">Type  <span class="text-danger">*</span></label>
  <div class="select-wrapper">
    <select id="employee_type"
            name="type"
            class="{% if errors.type %}is-invalid{% endif %}" tabindex="31">
          <option value="" selected disabled hidden></option>
      <option value="limited"
        {% if posted.type == 'limited' or employee_data.type == 'limited' %}selected{% endif %}>
        Limited
      </option>
      <option value="admin"
        {% if posted.type == 'admin' or employee_data.type == 'admin' %}selected{% endif %}>
        Admin
      </option>
    </select>
  </div>
  <div class="field-error" data-error-for="type">
    {% if errors.type %}{{ errors.type }}{% endif %}
  </div>
</div>
                 <div class="form-group relative">
                  <label for="username">Username <span class="text-danger">*</span></label>
                  <input id="username" name="username" type="text" class="form-control {% if errors.username %}is-invalid{% endif %}" value="{{employee_data.username|default:posted.username|default:''}}" tabindex="32" />
                  <div class="field-error" data-error-for="username">
                    {% if errors.username %}{{ errors.username }}{% elif field_errors.username %}{{ field_errors.username }}{% endif %}
                  </div>
                </div>
  <!-- Password -->
  <div class="form-group relative">
    <label for="password">Password </label>
    <input
      id="password"
      name="password"
      type="password"
      class="form-control {% if errors.password %}is-invalid{% endif %}"
      autocomplete="new-password"
      aria-describedby="err-password"
      placeholder="Leave empty if you do not want to change the password"
      tabindex="33"
    />
    <button type="button" class="password-toggle" data-target="password" aria-label="Toggle password visibility">Show</button>
    <div class="field-error" data-error-for="password" id="err-password" role="alert" aria-live="polite">
      {% if errors.password %}{{ errors.password }}{% elif field_errors.password %}{{ field_errors.password }}{% endif %}
    </div>
  </div>

  <!-- Confirm Password -->
  <div class="form-group relative">
    <label for="confirmPassword">Confirm Password </label>
    <input
      id="confirmPassword"
      name="confirmPassword"
      type="password"
      class="form-control {% if errors.confirmPassword %}is-invalid{% endif %}"
      autocomplete="new-password"
      aria-describedby="err-confirmPassword"
      placeholder="Leave empty if you do not want to change the password"
      tabindex="34"
    />
    <button type="button" class="password-toggle" data-target="confirmPassword" aria-label="Toggle confirm password visibility">Show</button>
    <div class="field-error" data-error-for="confirmPassword" id="err-confirmPassword" role="alert" aria-live="polite">
      {% if errors.confirmPassword %}{{ errors.confirmPassword }}{% elif field_errors.confirmPassword %}{{ field_errors.confirmPassword }}{% endif %}
    </div>
  </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".password-toggle").forEach(function (button) {
          button.addEventListener("click", function () {
            var targetId = button.getAttribute("data-target");
            var input = document.getElementById(targetId);
            if (input) {
              if (input.type === "password") {
                input.type = "text";
                button.textContent = "Hide";
              } else {
                input.type = "password";
                button.textContent = "Show";
              }
            }
          });
        });
      });
    </script>


</div>

  </div>

  <!-- Submit area (kept outside panels but inside bottom-section) -->
  <div class="actions" style="margin-top:12px;">
    <a href="{% url 'employee:employee_list' %}" class="btn btn-secondary">Back</a>
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#employeeLogModal">
      <i class="fa fa-book mr-1"></i> Log
    </button>
    <button type="submit" class="btn btn-primary btn-primary-strong ladda-button ladda-button-demo">Update</button>
  </div>

</div> <!-- /.bottom-section -->


        </form>
      </div> <!-- /.form-col -->

    </div> <!-- .card-body -->
  </div> <!-- .card-centered -->
</div> <!-- .wrapper -->



<div class="modal fade" id="employeeLogModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content animated bounceInRight">
      <div class="modal-header">
        <h4 class="modal-title">Employee Change Log</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th style="width: 30%">User & Timestamp</th>
              <th style="width: 70%">Field Changes</th>
            </tr>
          </thead>
          <tbody>
            {% if update_groups %}
              {% for group in update_groups %}
                <tr>
                  <td style="width:30%;">
                    <div style="display:flex; align-items:center;">
                      <img src="{% static 'assets/img/user.png' %}" alt="User" style="width:40px; height:40px; margin-right:10px;">
                      <div>
                        <strong>User:</strong> {{ group.changed_by }} <br>
                        <strong>Date:</strong> 
                        <span class="log-timestamp" data-utc="{{ group.change_timestamp }}">
                            {{ group.change_timestamp }}
                          </span>
                      </div>
                    </div>
                  </td>
                  <td style="width:70%;">
                    {% for log in group.changes %}
                      <p style="margin-bottom:6px; display:flex; align-items:flex-start;">
                        <span style="min-width:150px; font-weight:600;">{{ log.field_changed }}:</span>
                        <span style="display:inline-block; max-width:calc(100% - 150px); overflow-wrap:break-word;">
                          {% if log.old_value %}{{ log.old_value }}{% else %}<em>(empty)</em>{% endif %}
                          &nbsp;&rarr;&nbsp;
                          {% if log.new_value %}{{ log.new_value }}{% else %}<em>(empty)</em>{% endif %}
                        </span>
                      </p>
                    {% endfor %}
                  </td>
                </tr>
              {% endfor %}
            {% endif %}

            {% if create_groups %}
              {% for group in create_groups %}
                <tr>
                  <td style="width:30%;">
                    <div style="display:flex; align-items:center;">
                      <img src="{% static 'assets/img/user.png' %}" alt="User" style="width:40px; height:40px; margin-right:10px;">
                      <div>
                        <strong>User:</strong> {{ group.changed_by }} <span class="badge badge-success" style="margin-left:8px;">Created</span> <br>
                        <strong>Date:</strong>
                                                <span class="log-timestamp" data-utc="{{ group.change_timestamp }}">
                            {{ group.change_timestamp }}
                          </span>
                      </div>
                    </div>
                  </td>
                  <td style="width:70%;">
                    {# Optionally show snapshot summary or leave empty - we mirrored LCO #}
                  </td>
                </tr>
              {% endfor %}
            {% endif %}

            {% if not update_groups and not create_groups %}
              <tr><td colspan="2" class="text-center">No changes recorded.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* ---------- general modal layout ---------- */
  .modal.fixed-size .modal-dialog { max-width: 900px; }
  .modal.fixed-size .modal-body { padding: 18px; }

  /* container: two columns */
  .modal-split { display: flex; gap: 18px; align-items: stretch; }

  /* left form panel (highlighted) */
  .panel-left {
  /* ~48% width for left */
  flex: 0 1 48%;
  background: #f7fbff;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 6px 12px rgba(16,24,40,0.03);
  min-width: 220px; /* prevents extremely narrow left column */
}

  /* right list panel */
  .panel-right {
  /* ~52% width for right (slightly larger) */
  flex: 0 1 52%;
  background: #ffffff;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 6px 12px rgba(16,24,40,0.03);
  display: flex;
  flex-direction: column;
  min-width: 300px;
}

  /* headings */
  .panel-heading { font-weight: 700; margin-bottom: 8px; color: #0b2545; padding: 1px 1px; }

  /* inputs */
  .panel-left .form-control, .panel-right .form-control { border-radius: 6px; }

  /* list-box: show ~4 rows */
  .list-box {
    height: calc(4 * 48px + 12px); /* approx 4 rows */
    overflow-y: auto;
    border: 1px solid #eef2f6;
    border-radius: 6px;
    padding: 8px;
    background: #fbfdff;
  }

  /* list row */
  .list-row {
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:8px 6px;
    border-bottom: 1px solid rgba(12,16,22,0.03);
    align-items:center;
    height: 48px;
    box-sizing: border-box;
  }
  .list-row:last-child { border-bottom: none; }
  .list-row .title { font-weight:600; color:#0b2545; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%; }
  .list-row .meta { font-size: .85rem; color:#6b7280; }

  /* empty state */
  .list-empty { text-align:center; padding:18px; color:#6b7280; }

  /* small responsive tweaks */
  @media (max-width: 768px) {
    .modal-split { flex-direction: column; }
    .panel-left { border-left: none; border-top: 4px solid #0069d9; }
    .panel-right { min-width: auto; width: 100%; }
  }

  /* optional small helper for the internal "row" used earlier in examples */
   #positionList, #departmentList {
    border: 1px solid #e9ecef;
    padding: 8px;
    border-radius: 4px;
    overflow-y: auto;
    max-height: 340px;
    background: #fff;
  }
</style>



<!-- Position modal -->
<div class="modal fade fixed-size" id="modalCreatePosition" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <form id="formCreatePosition" novalidate>
        <div class="modal-header">
          <h5 class="modal-title"><span id="positionModalTitle">Create Position</span></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <div class="modal-split d-flex">
            <!-- LEFT: form -->
            <div class="panel-left" style="flex:1; padding-right:16px;">
              <div class="panel-heading">Position</div>
              <input type="hidden" id="create_position_id" value="">
              <div class="form-group">
                <label for="create_position_name">Name <span class="text-danger">*</span></label>
                <input type="text" id="create_position_name" name="name" class="form-control" required autocomplete="off">
                <small class="text-danger d-none" id="create_position_name_error"></small>
              </div>
              <div class="form-group">
                <label for="create_position_code">Code (optional)</label>
                <input type="text" id="create_position_code" name="code" class="form-control" autocomplete="off">
                <small class="text-danger d-none" id="create_position_code_error"></small>
              </div>
              <div class="alert alert-danger d-none" id="create_position_nonfield"></div>
              <div class="d-flex justify-content-end" style="gap:8px; margin-top:12px;">
                <button type="button" id="createPositionBtn" class="btn btn-primary">Create</button>
                <button type="button" id="updatePositionBtn" class="btn btn-primary d-none">Update</button>
                <button type="button" id="positionCancelEditBtn" class="btn btn-outline-secondary d-none">Cancel Edit</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>

            <!-- RIGHT: search + list -->
            <div class="panel-right" style="width:420px; margin-left:12px;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-heading">Existing Positions</div>
                <div><small class="text-muted" id="positionListCount">0</small></div>
              </div>
              <div style="margin-bottom:10px;">
                <div class="input-group input-group-sm">
                  <input type="search" id="positionListSearch" class="form-control form-control-sm" placeholder="Search positions..." autocomplete="off">
                </div>
              </div>
              <div id="positionList" class="list-box" style="max-height:340px; overflow:auto;">
                <div class="list-empty">Loading…</div>
              </div>
              <div class="mt-2" style="font-size:13px;color:#6b7280;">Tip: search to filter; click Edit to load into the form.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer"></div>
      </form>
    </div>
  </div>
</div>

<!-- Department modal -->
<div class="modal fade fixed-size" id="modalCreateDepartment" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <form id="formCreateDepartment" novalidate>
        <div class="modal-header">
          <h5 class="modal-title"><span id="departmentModalTitle">Create Department</span></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
        </div>
        <div class="modal-body">
          {% csrf_token %}
          <div class="modal-split d-flex">
            <!-- LEFT: form -->
            <div class="panel-left" style="flex:1; padding-right:16px;">
              <div class="panel-heading">Department</div>
              <input type="hidden" id="create_department_id" value="">
              <div class="form-group">
                <label for="create_department_name">Name <span class="text-danger">*</span></label>
                <input type="text" id="create_department_name" name="name" class="form-control" required autocomplete="off">
                <small class="text-danger d-none" id="create_department_name_error"></small>
              </div>
              <div class="form-group">
                <label for="create_department_code">Code (optional)</label>
                <input type="text" id="create_department_code" name="code" class="form-control" autocomplete="off">
                <small class="text-danger d-none" id="create_department_code_error"></small>
              </div>
              <div class="alert alert-danger d-none" id="create_department_nonfield"></div>
              <div class="d-flex justify-content-end" style="gap:8px; margin-top:12px;">
                <button type="button" id="createDepartmentBtn" class="btn btn-primary">Create</button>
                <button type="button" id="updateDepartmentBtn" class="btn btn-primary d-none">Update</button>
                <button type="button" id="departmentCancelEditBtn" class="btn btn-outline-secondary d-none">Cancel Edit</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>

            <!-- RIGHT: search + list -->
            <div class="panel-right" style="width:420px; margin-left:12px;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-heading">Existing Departments</div>
                <div><small class="text-muted" id="departmentListCount">0</small></div>
              </div>
              <div style="margin-bottom:10px;">
                <div class="input-group input-group-sm">
                  <input type="search" id="departmentListSearch" class="form-control form-control-sm" placeholder="Search departments..." autocomplete="off">
                </div>
              </div>
              <div id="departmentList" class="list-box" style="max-height:340px; overflow:auto;">
                <div class="list-empty">Loading…</div>
              </div>
              <div class="mt-2" style="font-size:13px;color:#6b7280;">Tip: search to filter; click Edit to load into the form.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer"></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade fixed-size" id="modalCreateMaritalStatus" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <form id="formCreateMaritalStatus" novalidate>
        <div class="modal-header">
          <h5 class="modal-title"><span id="maritalStatusModalTitle">Create Marital Status</span></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">×</button>
        </div>

        <div class="modal-body">
          {% csrf_token %}
          <div class="modal-split d-flex">
            <!-- LEFT PANEL: Create/Edit form -->
            <div class="panel-left" style="flex:1; padding-right:16px;">
              <div class="panel-heading">Marital Status</div>
              <input type="hidden" id="create_marital_status_id" value="">

              <div class="form-group">
                <label for="create_marital_status_name">Name <span class="text-danger">*</span></label>
                <input type="text" id="create_marital_status_name" name="name" class="form-control" required autocomplete="off">
                <small class="text-danger d-none" id="create_marital_status_name_error"></small>
              </div>

              <div class="form-group d-none">
                <label for="create_marital_status_code">Description (optional)</label>
                <input type="text" id="create_marital_status_code" name="code" class="form-control " autocomplete="off">
                <small class="text-danger d-none" id="create_marital_status_code_error"></small>
              </div>

              <div class="alert alert-danger d-none" id="create_marital_status_nonfield"></div>

              <div class="d-flex justify-content-end" style="gap:8px; margin-top:12px;">
                <button type="button" id="createMaritalStatusBtn" class="btn btn-primary">Create</button>
                <button type="button" id="updateMaritalStatusBtn" class="btn btn-primary d-none">Update</button>
                <button type="button" id="maritalStatusCancelEditBtn" class="btn btn-outline-secondary d-none">Cancel Edit</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              </div>
            </div>

            <!-- RIGHT PANEL: Existing list -->
            <div class="panel-right" style="width:420px; margin-left:12px;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-heading">Existing Marital Statuses</div>
                <div><small class="text-muted" id="maritalStatusListCount">0</small></div>
              </div>

              <div style="margin-bottom:10px;">
                <div class="input-group input-group-sm">
                  <input type="search" id="maritalStatusListSearch" class="form-control form-control-sm" placeholder="Search marital statuses..." autocomplete="off">
                </div>
              </div>

              <div id="maritalStatusList" class="list-box" style="max-height:340px; overflow:auto;">
                <div class="list-empty">Loading…</div>
              </div>

              <div class="mt-2" style="font-size:13px;color:#6b7280;">
                Tip: search to filter; click Edit to load into the form.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer"></div>
      </form>
    </div>
  </div>
</div>



{% endblock %}
{% block extra_scripts %}

<script>
/**
 * Sequential Tab Navigation System
 * Handles automatic tab navigation through all form sections:
 * 1. Top section (basic info)
 * 2. Working Info tab
 * 3. Salary tab
 * 4. Personal Info tab
 * 5. Login Info tab
 * Then cycles back to first input
 */
(function($) {
  $(document).ready(function() {
    // Define all form inputs in sequential order with their tabindex
    var formFields = [
      // Top Section (Basic Info)
      { selector: '#name', tabindex: 1, section: 'top' },
      { selector: '#email', tabindex: 2, section: 'top' },
      { selector: '#mobile', tabindex: 3, section: 'top' },
      { selector: '#gender', tabindex: 4, section: 'top' },
      { selector: '#branch', tabindex: 5, section: 'top' },
      { selector: '#allowed_branches', tabindex: 6, section: 'top' },
      
      // Working Info Section
      { selector: '#position', tabindex: 7, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      { selector: '#department', tabindex: 8, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      { selector: '#manager', tabindex: 9, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      { selector: '#employeeId', tabindex: 10, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      { selector: '#workEmail', tabindex: 11, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      { selector: '#workMobile', tabindex: 12, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      { selector: '#workPhone', tabindex: 13, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      { selector: '#workLocation', tabindex: 14, section: 'working', panel: '#panel-working', tabBtn: '#tab-working' },
      
      // Salary Section
      { selector: '#basicSalary', tabindex: 15, section: 'salary', panel: '#panel-salary', tabBtn: '#tab-salary' },
      { selector: '#da', tabindex: 16, section: 'salary', panel: '#panel-salary', tabBtn: '#tab-salary' },
      { selector: '#hra', tabindex: 17, section: 'salary', panel: '#panel-salary', tabBtn: '#tab-salary' },
      
      // Personal Info Section
      { selector: '#address', tabindex: 18, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#dateOfBirth', tabindex: 19, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#maritalStatus', tabindex: 20, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#country', tabindex: 21, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#state', tabindex: 22, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#district', tabindex: 23, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#city', tabindex: 24, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#pinCode', tabindex: 25, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#aadhaarNumber', tabindex: 26, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#passportNumber', tabindex: 27, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#numberOfChildren', tabindex: 28, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#emgContactName', tabindex: 29, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      { selector: '#emgPhone', tabindex: 30, section: 'personal', panel: '#panel-personal', tabBtn: '#tab-personal' },
      
      // Login Info Section
      { selector: '#employee_type', tabindex: 31, section: 'login', panel: '#panel-login', tabBtn: '#tab-login' },
      { selector: '#username', tabindex: 32, section: 'login', panel: '#panel-login', tabBtn: '#tab-login' },
      { selector: '#password', tabindex: 33, section: 'login', panel: '#panel-login', tabBtn: '#tab-login' },
      { selector: '#confirmPassword', tabindex: 34, section: 'login', panel: '#panel-login', tabBtn: '#tab-login' }
    ];

    // Function to activate a tab panel
    function activateTabPanel(tabBtnSelector, panelSelector) {
      // Hide all panels
      $('.panel-section').hide().attr('aria-hidden', 'true');
      
      // Show target panel
      $(panelSelector).show().attr('aria-hidden', 'false');
      
      // Update tab buttons
      $('.tab-btn').removeClass('active').attr('aria-selected', 'false');
      $(tabBtnSelector).addClass('active').attr('aria-selected', 'true');
    }

    // Function to get the actual focusable element (handles Selectize/Select2)
    function getFocusableElement(field) {
      var $el = $(field.selector);
      if (!$el.length) return null;
      
      // Check if it's a Selectize field
      if ($el[0] && $el[0].selectize) {
        // For Selectize, focus the input inside the control
        var selectize = $el[0].selectize;
        if (selectize.$control && selectize.$control.length) {
          var $input = selectize.$control.find('input');
          if ($input.length) return $input[0];
        }
        return $el[0];
      }
      
      // Check if it's a Select2 field
      if ($el.hasClass('select2-hidden-accessible')) {
        var $select2 = $el.next('.select2');
        if ($select2.length) {
          var $select2Input = $select2.find('.select2-selection');
          if ($select2Input.length) return $select2Input[0];
        }
      }
      
      // Regular input/select
      return $el[0];
    }

    // Function to focus a field
    function focusField(field) {
      var element = getFocusableElement(field);
      if (!element) return false;
      
      // Activate tab panel if needed
      if (field.panel && field.tabBtn) {
        activateTabPanel(field.tabBtn, field.panel);
        // Small delay to ensure panel is visible
        setTimeout(function() {
          try {
            element.focus();
            // For Selectize, also trigger open
            var $el = $(field.selector);
            if ($el[0] && $el[0].selectize) {
              setTimeout(function() {
                try { $el[0].selectize.open(); } catch(e) {}
              }, 50);
            }
          } catch(e) {
            console.warn('Focus failed for', field.selector, e);
          }
        }, 100);
      } else {
        try {
          element.focus();
          // For Selectize, also trigger open
          var $el = $(field.selector);
          if ($el[0] && $el[0].selectize) {
            setTimeout(function() {
              try { $el[0].selectize.open(); } catch(e) {}
            }, 50);
          }
        } catch(e) {
          console.warn('Focus failed for', field.selector, e);
        }
      }
      
      return true;
    }

    // Function to find current field index
    function getCurrentFieldIndex() {
      var activeElement = document.activeElement;
      if (!activeElement) return -1;
      
      // Check if active element is inside a selectize/select2 control
      var $active = $(activeElement);
      var $closestSelect = $active.closest('.selectize-control, .select2-container');
      
      for (var i = 0; i < formFields.length; i++) {
        var $field = $(formFields[i].selector);
        if (!$field.length) continue;
        
        // Check if active element matches this field or is inside its control
        if (activeElement === $field[0] || 
            $field[0] === activeElement ||
            ($closestSelect.length && $closestSelect.prev(formFields[i].selector).length) ||
            ($closestSelect.length && $closestSelect.closest('.form-group').find(formFields[i].selector).length)) {
          return i;
        }
      }
      
      return -1;
    }

    // Handle Tab key navigation
    $(document).on('keydown', 'input, select, textarea', function(e) {
      // Only handle Tab key (keyCode 9)
      if (e.keyCode !== 9) return;
      
      var currentIndex = getCurrentFieldIndex();
      if (currentIndex === -1) return;
      
      // If Shift+Tab (going backwards)
      if (e.shiftKey) {
        e.preventDefault();
        var prevIndex = currentIndex - 1;
        if (prevIndex < 0) prevIndex = formFields.length - 1; // Cycle to last
        focusField(formFields[prevIndex]);
        return false;
      }
      
      // Regular Tab (going forwards)
      // Check if we're at the last field
      if (currentIndex === formFields.length - 1) {
        e.preventDefault();
        // Cycle back to first field
        focusField(formFields[0]);
        return false;
      }
      
      // Normal forward navigation - let browser handle it, but ensure panel is activated
      var nextIndex = currentIndex + 1;
      if (nextIndex < formFields.length) {
        var nextField = formFields[nextIndex];
        if (nextField.panel && nextField.tabBtn) {
          // Activate panel immediately
          activateTabPanel(nextField.tabBtn, nextField.panel);
        }
      }
    });

    // Set tabindex attributes on all fields
    formFields.forEach(function(field) {
      var $el = $(field.selector);
      if ($el.length) {
        $el.attr('tabindex', field.tabindex);
      }
    });

    // Auto-focus first field on page load
    setTimeout(function() {
      if (formFields.length > 0) {
        focusField(formFields[0]);
      }
    }, 300); // Small delay to ensure Selectize/Select2 are initialized

    // Also handle when user clicks on a field - ensure correct tab is active
    formFields.forEach(function(field) {
      $(field.selector).on('focus click', function() {
        if (field.panel && field.tabBtn) {
          activateTabPanel(field.tabBtn, field.panel);
        }
      });
    });

    // Expose utility function for manual navigation if needed
    window.navigateToField = function(tabindex) {
      var field = formFields.find(function(f) { return f.tabindex === tabindex; });
      if (field) {
        focusField(field);
      }
    };
  });
})(jQuery);
</script>

<!-- 
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('employeeForm');
    const submitBtn = document.getElementById('submitBtn');

    // Store initial form values
    const initialData = new FormData(form);

    // Function to check if form changed
    function isFormChanged() {
        const currentData = new FormData(form);
        for (let [key, value] of currentData.entries()) {
            if (value !== initialData.get(key)) {
                return true;
            }
        }
        return false;
    }

    // Add input/change listeners to all form fields
    form.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('input', () => {
            submitBtn.disabled = !isFormChanged();
        });
        field.addEventListener('change', () => {
            submitBtn.disabled = !isFormChanged();
        });
    });
});
</script> -->


  <script>
(function($){
  var imageUrlServer = "{{ image_url|default:''|escapejs }}"; // server-provided initial image URL
  var currentObjectUrl = null;

  // cached jQuery refs (we will refresh $file when we replace it)
  var $img = $('#imagePreview');
  var $ph = $('#imagePlaceholder');
  var $btnRemove = $('#btnRemoveImage');
  var $btnChoose = $('#btnChooseImage');
  var $deleteFlag = $('#id_delete_image');


  var cachedPreviewUrl = null;
  // show server image (when available)
  function showServerImage(){
      if (imageUrlServer) {
          $img.attr('src', imageUrlServer).show();
          $ph.hide();
          $btnRemove.show();
          $deleteFlag.val("0");
          cachedPreviewUrl = imageUrlServer; // Cache the server URL as the initial state
      } else {
          showPlaceholder();
      }
  }

  function showPlaceholder(){
    // clear src and show placeholder
    try { $img.attr('src','').hide(); } catch(e){}
    $ph.show();
    $btnRemove.hide();
    $deleteFlag.val("0"); // leave as 0 unless explicit remove
  }

  // cleanup current object URL if any
  function revokeCurrentObjectUrl(){
    if (currentObjectUrl) {
      try { URL.revokeObjectURL(currentObjectUrl); } catch(e) {}
      currentObjectUrl = null;
    }
  }

  // actual preview logic for a File object
// actual preview logic for a File object
function previewFile(file){
    if (!file) {
        // This block should theoretically not run if the user cancels, 
        // but we handle it as a cleanup fallback if the input was cleared.
        
        if ($deleteFlag.val() !== "1" && (imageUrlServer || cachedPreviewUrl)) {
             // If no file, but we have a cache/server image, restore the last known good state
             $img.attr('src', cachedPreviewUrl || imageUrlServer).show();
             $ph.hide();
             $btnRemove.show();
        } else {
            showPlaceholder();
        }
        return;
    }

    if (!file.type || !file.type.match('image.*')) {
        showPlaceholder();
        return;
    }

    revokeCurrentObjectUrl();
    // try object URL (or FileReader fallback)
    try {
        var obj = URL.createObjectURL(file);
        currentObjectUrl = obj;
        $img.attr('src', obj).show();
        $ph.hide();
        $btnRemove.show();

        // revoke after image loaded
        $img.one('load.previewCleanup', function(){
            try { URL.revokeObjectURL(obj); } catch(e){}
            if (currentObjectUrl === obj) currentObjectUrl = null;
        });
    } catch (err) {
        // fallback FileReader
        var reader = new FileReader();
        reader.onload = function(evt){
            $img.attr('src', evt.target.result).show();
            $ph.hide();
            $btnRemove.show();
        };
        reader.readAsDataURL(file);
    }

    // new upload means don't mark delete flag
    var newSrc = $img.attr('src');
    if (newSrc) {
        cachedPreviewUrl = newSrc; // Update cache with the new temporary URL
    }
    $deleteFlag.val("0");
}

  // bind the "change" handler to the current file input
// --- 3. The Core Fix in bindFileInput() ---
function bindFileInput(){
    var $file = $('#id_image'); // Assuming this is your correct file input ID

    // We no longer trigger click via the label, we use a separate handler for control.
    $btnChoose.off('click.choose').on('click.choose', function(e){
        e.preventDefault();
        
        // 1. Store the previous state
        var oldSrc = $img.attr('src');
        
        // 2. Clear the file input immediately (crucial for Chrome/Edge/Firefox state management)
        $file.val(''); 

        // 3. Trigger the file dialog
        $file.trigger('click');

        // 4. Set a short timeout to check the result after the dialog closes.
        // If the user cancelled, the 'change' event might not fire, and the input remains empty.
        setTimeout(function() {
            // Check if the input value is STILL empty AND if the change event didn't fire (i.e., no file selected)
            if ($file.val() === '') {
                
                // If the user cancelled, the 'change' handler hasn't run to set a new preview.
                // We restore the old image from the cache.
                if (cachedPreviewUrl && $deleteFlag.val() !== "1") {
                    $img.attr('src', cachedPreviewUrl).show();
                    $ph.hide();
                    $btnRemove.show();
                } else if (imageUrlServer && $deleteFlag.val() !== "1") {
                    // Fallback to original server image
                    showServerImage();
                }
            }
        }, 10); 
    });

    // file change (this only runs if a NEW file is selected)
    $file.off('change.preview').on('change.preview', function(){
        var f = (this.files && this.files[0]) ? this.files[0] : null;
        previewFile(f);
    });
    
    return $file;
}
  // remove handler: clears file input and shows placeholder; marks delete flag = 1
  function setupRemove(){
    $btnRemove.off('click.remove').on('click.remove', function(e){
      e.preventDefault();

      // revoke any object URL
      revokeCurrentObjectUrl();

      // clear file input reliably by replacing it with a fresh clone (no value)
      var $old = $('#id_image');
      var $new = $old.clone(false);  // clone attributes, no event handlers
      $new.val(''); // ensure empty
      $old.replaceWith($new);

      // re-bind handlers to the new element
      bindFileInput();

      // show placeholder (and hide preview)
      $img.hide();
      $ph.show();
      $btnRemove.hide();

      // mark delete flag so server will remove stored image
      $deleteFlag.val("1");

      // optionally clear client-side validation
      try { if (typeof clearValidationArtifactsFor === 'function') clearValidationArtifactsFor($new); } catch(e){}
    });
  }

  // document ready
  $(function(){
    // initial UI state
    if (imageUrlServer && imageUrlServer.length) {
      showServerImage();
    } else {
      showPlaceholder();
    }

    // initial bind
    bindFileInput();
    setupRemove();
  });

})(jQuery);
</script>







<script>
(function($){
  $(function(){

    // Prevent double-init if script included twice
    if (window.__employee_entities_initialized) return;
    window.__employee_entities_initialized = true;

    // CSRF helper (Django)
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    var CSRF_TOKEN = getCookie('csrftoken');

    // Replace these Django URL tags as needed
    var urls = {
      listPosition:   "{% url 'employee:list_positions_ajax' %}",
      createPosition: "{% url 'employee:create_position_ajax' %}",
      updatePosition: "{% url 'employee:update_position_ajax' %}",
      listDepartment:   "{% url 'employee:list_departments_ajax' %}",
      createDepartment: "{% url 'employee:create_department_ajax' %}",
      updateDepartment: "{% url 'employee:update_department_ajax' %}",
      listMaritalStatus: "{% url 'employee:list_marital_status_ajax' %}",
      createMaritalStatus: "{% url 'employee:create_marital_status_ajax' %}",
      updateMaritalStatus: "{% url 'employee:update_marital_status_ajax' %}"
    };

    // small debounce util
    function debounce(fn, wait){
      var t;
      return function(){
        var ctx = this, args = arguments;
        clearTimeout(t);
        t = setTimeout(function(){ fn.apply(ctx, args); }, wait || 250);
      };
    }

    // modal helper (bootstrap3/4/5 compatibility)
    var modalInstances = {};
    function showModal(selector) {
      var $el = $(selector);
      if (!$el.length) { console.warn('Modal element not found:', selector); return; }
      if (window.bootstrap && typeof window.bootstrap.Modal === 'function') {
        if (!modalInstances[selector]) {
          modalInstances[selector] = new window.bootstrap.Modal($el[0], { backdrop: 'static', keyboard: true });
        }
        modalInstances[selector].show();
        return;
      }
      if ($.fn && typeof $.fn.modal === 'function') {
        try { $el.modal('show'); return; } catch(e){ console.warn(e); }
      }
      alert('Please open the modal manually (programmatic open unavailable).');
    }

    // selectize helpers (if present)
    function getSelectizeInst($select) {
      if (!$select || !$select.length) return null;
      try { return ($select[0] && $select[0].selectize) ? $select[0].selectize : null; } catch(e){ return null; }
    }
    function clearSelectValue($select) {
      if (!$select || !$select.length) return;
      var inst = getSelectizeInst($select);
      try {
        if (inst) { inst.clear(); inst.close(); setTimeout(function(){ try{ inst.focus(); }catch(e){} }, 8); }
        $select.val('').trigger('change');
      } catch(e){
        try { $select.val(''); $select.trigger('change'); } catch(_) {}
      }
    }
    function initSelectizeIfNeeded(selector, placeholder) {
      var $s = $(selector);
      if (!$s.length) return null;
      if (!$.fn || typeof $.fn.selectize !== 'function') return null;
      if ($s.data('selectize')) return getSelectizeInst($s);
      try {
        var inst = $s.selectize({
          create: false,
          allowEmptyOption: true,
          placeholder: placeholder || ($s.find('option[value=""]').first().text() || ''),
          plugins: ['clear_button'],
          onChange: function(val) { $s.trigger('change'); }
        })[0].selectize;
        return inst;
      } catch(e){ console.warn('Selectize init failed for', selector, e); return null; }
    }

    // --- DOM helpers ---
    // makeRow now sets data-entity attribute and uses provided onEdit callback only
    function makeRow(item, entityName, onEdit){
      var $row = $('<div class="list-row d-flex"></div>');
      $row.attr('data-id', String(item.id));
      $row.attr('data-name', item.name || '');
      $row.attr('data-code', item.code || '');
      if (entityName) $row.attr('data-entity', entityName);

      var $left = $('<div class="d-flex flex-column list-left" style="flex:1 1 auto;"></div>');
      $left.append($('<div class="title"></div>').text(item.name));
      $left.append($('<small class="meta"></small>').text(item.code ? ('Code: ' + item.code) : ''));

      var $actions = $('<div class="list-actions" style="flex:0 0 auto; margin-left:12px;"></div>');
      var $editBtn = $('<button type="button" class="btn btn-sm btn-link text-primary" title="Edit"><i class="fa fa-edit"></i></button>');

      // wire edit to provided onEdit (module-specific) — avoid global lookup ambiguity
      $editBtn.on('click.entity', function(e){
        e.preventDefault();
        var id = $row.attr('data-id');
        var name = $row.attr('data-name') || $row.find('.title').text() || '';
        var code = $row.attr('data-code') || $row.find('.meta').text().replace(/^Code:\s*/, '') || '';
        if (typeof onEdit === 'function') {
          try { onEdit({ id: id, name: name, code: code, entity: entityName }); }
          catch(ex) { console.warn('onEdit callback failed', ex); }
        } else {
          // fallback: trigger global event with entity meta so global handlers can disambiguate
          $(document).trigger('entity:edit', [{ id: id, name: name, code: code, entity: entityName }]);
        }
      });

      $actions.append($editBtn);
      $row.append($left).append($actions);
      return $row;
    }

    function addOrUpdateOption($select, id, text){
      if (!$select || !$select.length) return;
      var val = String(id);
      var existing = $select.find('option[value="' + val + '"]');
      if (existing.length) {
        existing.text(text);
      } else {
        // prepend so it's visible
        $select.prepend(new Option(text, val, true, true));
      }
      try {
        var s = getSelectizeInst($select);
        if (s) {
          if (s.options[val]) s.updateOption(val, { value: val, text: text });
          else s.addOption({ value: val, text: text });
          s.setValue(val);
          setTimeout(function(){ s.focus(); }, 20);
        } else {
          $select.val(val).trigger('change');
          setTimeout(function(){ $select.focus(); }, 20);
        }
      } catch(e){
        $select.val(val).trigger('change');
      }
    }

    // upsertRow now accepts module-specific onEdit and entityName to avoid global-id collisions
    function findRow($list, id) { return $list.find('.list-row[data-id="' + String(id) + '"]'); }

    function upsertRow($list, item, opts, onEdit, entityName) {
      opts = opts || {};
      var $existing = findRow($list, item.id);
      if ($existing.length) {
        var st = $list.scrollTop();
        $existing.find('.title').first().text(item.name);
        $existing.find('.meta').first().text(item.code ? ('Code: ' + item.code) : '');
        $existing.attr('data-name', item.name || '');
        $existing.attr('data-code', item.code || '');
        if (entityName) $existing.attr('data-entity', entityName);
        $list.scrollTop(st);
        return { updated: true, added: false };
      } else {
        var $row = makeRow(item, entityName, onEdit);
        var previousScroll = $list.scrollTop();
        $list.prepend($row);
        try {
          var $countNode = $($list.data('count-node'));
          if ($countNode && $countNode.length) {
            var cur = parseInt($countNode.text(),10) || $list.find('.list-row').length;
            $countNode.text(cur + 1);
          }
        } catch(e){}
        if (opts.showAtTop) $list.animate({ scrollTop: 0 }, 160);
        else $list.scrollTop(previousScroll);
        return { updated: false, added: true };
      }
    }

    function prettyTypeFrom(inputSelector) {
      var m = inputSelector.match(/create_([a-zA-Z_]+)_name/);
      if (m && m[1]) {
        var t = m[1].replace(/_/g,' ');
        return t.charAt(0).toUpperCase() + t.slice(1);
      }
      return 'Item';
    }

    // --- generic entity module factory ---
    function makeEntityModule(cfg){
      var entityName = cfg.entityName || (cfg.nameInput || '').replace(/^#?create_?/,'').split('_')[0] || ''; // fallback
      var $select = $(cfg.select);
      var $list = $(cfg.listArea);
      if (cfg.listCount) $list.data('count-node', cfg.listCount);
      var $count = $(cfg.listCount);
      var urlsLocal = cfg.urls;
      var $search = $(cfg.search);
      var $modal = $(cfg.modal);
      var $form = $(cfg.form);
      var $id = $(cfg.idInput), $name = $(cfg.nameInput), $code = $(cfg.codeInput);
      var $createBtn = $(cfg.createBtn), $updateBtn = $(cfg.updateBtn), $cancelBtn = $(cfg.cancelBtn);
      var nonfield = cfg.nonfield;
      var prettyType = prettyTypeFrom(cfg.nameInput);

      // simple state
      var submitting = false;

      // field error helpers with auto-hide
      function showFieldError(inputSelector, msg) {
        try {
          var errId = inputSelector.replace('#','') + '_error';
          var $err = $('#' + errId);
          var $input = $(inputSelector);
          if (!$err.length) return;
          clearTimeout($err.data('hideTimeout'));
          $err.removeClass('d-none').text(msg || '');
          $input.addClass('is-invalid');
          var t = setTimeout(function(){
            try { $err.addClass('d-none').text(''); $input.removeClass('is-invalid'); } catch(e){}
          }, 3000);
          $err.data('hideTimeout', t);
        } catch(e){ console.warn('showFieldError error', e); }
      }
      function clearFieldError(inputSelector) {
        try {
          var errId = inputSelector.replace('#','') + '_error';
          var $err = $('#' + errId);
          var $input = $(inputSelector);
          if (!$err.length) return;
          clearTimeout($err.data('hideTimeout'));
          $err.addClass('d-none').text('');
          $input.removeClass('is-invalid');
        } catch(e){ console.warn('clearFieldError error', e); }
      }

      // non-field messages
      function showNonField(msg, type){
        var $n = $(nonfield);
        if (!$n || !$n.length) return;
        $n.removeClass('d-none alert-success alert-danger alert-info')
          .addClass('alert alert-' + (type || 'info'))
          .text(msg || '');
        if (type === 'success') {
          clearTimeout($n.data('hideTimeout'));
          var t = setTimeout(function(){
            try { $n.addClass('d-none').removeClass('alert alert-success alert-danger alert-info').text(''); } catch(e){}
          }, 3000);
          $n.data('hideTimeout', t);
        }
      }
      function clearNonField(){
        var $n = $(nonfield);
        if (!$n || !$n.length) return;
        clearTimeout($n.data('hideTimeout'));
        $n.addClass('d-none').removeClass('alert alert-success alert-danger alert-info').text('');
      }

      function setLoading(){
        if (!$list.length) return;
        $list.empty().append('<div class="list-empty text-center text-muted py-3">Loading…</div>');
        if ($count && $count.length) $count.text('0');
      }

      function renderList(items){
        if (!$list.length) return;
        $list.empty();
        if (!items || items.length === 0) {
          $list.append('<div class="list-empty text-center text-muted py-3">No items found</div>');
          if ($count && $count.length) $count.text('0');
          return;
        }
        if ($count && $count.length) $count.text(items.length);
        items.forEach(function(it){
          $list.append(makeRow(it, entityName, startEdit));
        });
      }

      function loadList(q){
        if (!$list.length) return;
        setLoading();
        var u = urlsLocal.list + (q ? ('?q=' + encodeURIComponent(q)) : '');
        fetch(u, { credentials: 'same-origin' })
          .then(function(res){ return res.json(); })
          .then(function(json){
            if (json && Array.isArray(json.items)) renderList(json.items);
            else $list.html('<div class="list-empty text-center text-danger py-3">Unable to load</div>');
          })
          .catch(function(){ $list.html('<div class="list-empty text-center text-danger py-3">Failed to load</div>'); });
      }

      function resetForm(){
        $id.val('');
        $name.val('');
        $code.val('');
        clearFieldError(cfg.nameInput);
        clearFieldError(cfg.codeInput);
        clearNonField();
        $cancelBtn.addClass('d-none');
        $updateBtn.addClass('d-none');
        $createBtn.removeClass('d-none');
        submitting = false;
        $createBtn.prop('disabled', false);
        $updateBtn.prop('disabled', false);
        $form.removeData('submitting');
      }

      function startEdit(item){
        $id.val(item.id);
        $name.val(item.name);
        $code.val(item.code || '');
        $cancelBtn.removeClass('d-none');
        $updateBtn.removeClass('d-none');
        $createBtn.addClass('d-none');
        setTimeout(function(){ $name.trigger('focus'); }, 40);
      }

      // doSubmit uses module-specific startEdit when upserting
      async function doSubmit(mode){
        if (submitting || $form.data('submitting')) return;
        submitting = true;
        $form.data('submitting', true);

        clearFieldError(cfg.nameInput);
        clearFieldError(cfg.codeInput);
        clearNonField();

        var nameVal = ($name.val() || '').trim();
        var codeVal = ($code.val() || '').trim();

        if (!nameVal) { showFieldError(cfg.nameInput, 'Please enter a name.'); $name.trigger('focus'); submitting=false; $form.removeData('submitting'); return; }

        $createBtn.prop('disabled', true);
        $updateBtn.prop('disabled', true);

        var clientToken = $form.data('client-token') || (Math.random().toString(36).slice(2));
        $form.data('client-token', clientToken);

        var fd = new FormData();
        fd.append('name', nameVal);
        fd.append('code', codeVal);
        if (mode === 'update' && $id.val()) fd.append('id', $id.val());

        var url = (mode === 'update' && $id.val()) ? urlsLocal.update : urlsLocal.create;

        try {
          var headers = { 'X-CSRFToken': CSRF_TOKEN, 'X-Client-Token': clientToken, 'X-Requested-With': 'XMLHttpRequest' };
          var res = await fetch(url, { method: 'POST', credentials: 'same-origin', headers: headers, body: fd });
          var text = await res.text();
          var json = null;
          try { json = JSON.parse(text || '{}'); } catch(e){ json = null; }

          if (res.status === 200 || res.status === 201) {
            var resp = json || {};
            if (resp && resp.success) {
              var createdFlag = (typeof resp.created !== 'undefined') ? resp.created : true;

              if (!createdFlag) {
                var existMsg = prettyType + ' "' + (resp.name || nameVal) + '" already exists.';
                showFieldError(cfg.nameInput, prettyType + ' already exists.');
                showNonField(existMsg, 'danger');

                if (resp.id) {
                  try { addOrUpdateOption($select, resp.id, resp.name || nameVal); } catch(e){}
                  try { upsertRow($list, { id: resp.id, name: resp.name || nameVal, code: resp.code || codeVal || '' }, { showAtTop: false }, startEdit, entityName); } catch(e){}
                }
                return resp;
              }

              var item = { id: resp.id, name: resp.name, code: resp.code || codeVal || '' };

              if (mode === 'update') upsertRow($list, item, { showAtTop: false }, startEdit, entityName);
              else upsertRow($list, item, { showAtTop: true }, startEdit, entityName);

              addOrUpdateOption($select, resp.id, resp.name);

              resetForm();
              showNonField((mode === 'update' ? 'Updated' : 'Created') + ' successfully.', 'success');

              try {
                var s = getSelectizeInst($select);
                if (s) { s.setValue(String(resp.id)); setTimeout(function(){ s.focus(); }, 30); }
                else { $select.val(String(resp.id)).trigger('change'); setTimeout(function(){ $select.focus(); }, 30); }
              } catch(e){}
              return resp;
            } else {
              showNonField('Unexpected server response.', 'danger');
              return;
            }
          } else if (res.status === 400) {
            if (json && json.errors) {
              if (json.errors.name) showFieldError(cfg.nameInput, json.errors.name);
              if (json.errors.code) showFieldError(cfg.codeInput, json.errors.code);
              if (json.errors.__all__ || json.errors.non_field_errors) showNonField(json.errors.__all__ || json.errors.non_field_errors, 'danger');
            } else {
              showNonField('Validation failed (400).', 'danger');
            }
            return;
          } else {
            showNonField('Server error: ' + res.status, 'danger');
            return;
          }
        } catch(err) {
          console.warn('create/update error', err);
          showNonField('Network or server error occurred.', 'danger');
          return;
        } finally {
          submitting = false;
          $form.removeData('submitting');
          $createBtn.prop('disabled', false);
          $updateBtn.prop('disabled', false);
        }
      }

      // wire buttons (namespaced)
      $createBtn.off('.entity').on('click.entity', function(e){ e.preventDefault(); doSubmit('create'); });
      $updateBtn.off('.entity').on('click.entity', function(e){ e.preventDefault(); doSubmit('update'); });
      $cancelBtn.off('.entity').on('click.entity', function(e){ e.preventDefault(); resetForm(); });

      // prevent default form submit
      $form.off('.entity').on('submit.entity', function(e){ e.preventDefault(); var mode = ($id.val() && $id.val().length) ? 'update' : 'create'; doSubmit(mode); });

      // when modal shows: reset and load list
      $modal.off('.entity').on('show.bs.modal.entity', function(){
        resetForm();
        $form.data('client-token', Math.random().toString(36).slice(2));
        setTimeout(function(){ $search.trigger('focus'); }, 120);
        loadList('');
      });

      // search wiring (debounced)
      $search.off('.entity').on('input.entity', debounce(function(){ loadList($search.val() || ''); }, 200));

      return { loadList: loadList, startEdit: startEdit, resetForm: resetForm, entityName: entityName };
    } // makeEntityModule end

    // create instances
    var positionModule = makeEntityModule({
      entityName: 'position',
      select: '#position',
      listArea: '#positionList',
      listCount: '#positionListCount',
      search: '#positionListSearch',
      modal: '#modalCreatePosition',
      form: '#formCreatePosition',
      idInput: '#create_position_id',
      nameInput: '#create_position_name',
      codeInput: '#create_position_code',
      createBtn: '#createPositionBtn',
      updateBtn: '#updatePositionBtn',
      cancelBtn: '#positionCancelEditBtn',
      nonfield: '#create_position_nonfield',
      urls: { list: urls.listPosition, create: urls.createPosition, update: urls.updatePosition }
    });

    var departmentModule = makeEntityModule({
      entityName: 'department',
      select: '#department',
      listArea: '#departmentList',
      listCount: '#departmentListCount',
      search: '#departmentListSearch',
      modal: '#modalCreateDepartment',
      form: '#formCreateDepartment',
      idInput: '#create_department_id',
      nameInput: '#create_department_name',
      codeInput: '#create_department_code',
      createBtn: '#createDepartmentBtn',
      updateBtn: '#updateDepartmentBtn',
      cancelBtn: '#departmentCancelEditBtn',
      nonfield: '#create_department_nonfield',
      urls: { list: urls.listDepartment, create: urls.createDepartment, update: urls.updateDepartment }
    });

    var maritalStatusModule = makeEntityModule({
      entityName: 'marital_status',
      select: '#maritalStatus',
      listArea: '#maritalStatusList',
      listCount: '#maritalStatusListCount',
      search: '#maritalStatusListSearch',
      modal: '#modalCreateMaritalStatus',
      form: '#formCreateMaritalStatus',
      idInput: '#create_marital_status_id',
      nameInput: '#create_marital_status_name',
      codeInput: '#create_marital_status_code',
      createBtn: '#createMaritalStatusBtn',
      updateBtn: '#updateMaritalStatusBtn',
      cancelBtn: '#maritalStatusCancelEditBtn',
      nonfield: '#create_marital_status_nonfield',
      urls: { list: urls.listMaritalStatus, create: urls.createMaritalStatus, update: urls.updateMaritalStatus }
    });

    // expose map for backwards compat
    var MODULES_BY_ENTITY = {
      position: positionModule,
      department: departmentModule,
      marital_status: maritalStatusModule
    };

    // ---------- Selectize init (if present) ----------
    var posInst = initSelectizeIfNeeded('#position', 'Select position');
    var depInst = initSelectizeIfNeeded('#department', 'Select department');
    var maritalInst = initSelectizeIfNeeded('#marital_status', 'Select marital status');

    // ---------- intercept selectize 'create...' sentinel clicks ----------
    $(document).off('.entity').on('mousedown.entity touchstart.entity click.entity', '.selectize-dropdown .option[data-value^="__create_"]', function(e){
      e.preventDefault(); e.stopImmediatePropagation();
      var sentinel = $(this).attr('data-value') || '';
      if (sentinel.indexOf('__create_position') === 0) { showModal('#modalCreatePosition'); try{ if (posInst){ posInst.clear(); posInst.close(); posInst.focus(); } }catch(_){} $('select').filter(function(){ return $(this).find('option[value="__create_position__"]').length; }).each(function(){ $(this).val(''); $(this).trigger('change'); }); }
      if (sentinel.indexOf('__create_department') === 0) { showModal('#modalCreateDepartment'); try{ if (depInst){ depInst.clear(); depInst.close(); depInst.focus(); } }catch(_){} $('select').filter(function(){ return $(this).find('option[value="__create_department__"]').length; }).each(function(){ $(this).val(''); $(this).trigger('change'); }); }
      if (sentinel.indexOf('__create_marital_status') === 0) { showModal('#modalCreateMaritalStatus'); try{ if (maritalInst){ maritalInst.clear(); maritalInst.close(); maritalInst.focus(); } }catch(_){} $('select').filter(function(){ return $(this).find('option[value="__create_marital_status__"]').length; }).each(function(){ $(this).val(''); $(this).trigger('change'); }); }
      return false;
    });

    // native select fallback
    $(document).off('change.entity').on('change.entity', '#position', function(){
      var v = $(this).val();
      if (v === '__create_position__') { showModal('#modalCreatePosition'); setTimeout(function(){ clearSelectValue($('#position')); }, 8); }
    });
    $(document).off('change.entity').on('change.entity', '#department', function(){
      var v = $(this).val();
      if (v === '__create_department__') { showModal('#modalCreateDepartment'); setTimeout(function(){ clearSelectValue($('#department')); }, 8); }
    });
    $(document).off('change.entity').on('change.entity', '#marital_status', function(){
      var v = $(this).val();
      if (v === '__create_marital_status__') { showModal('#modalCreateMaritalStatus'); setTimeout(function(){ clearSelectValue($('#marital_status')); }, 8); }
    });

    // keyboard support for selects/selectize (Enter/Space/Tab)
    $(document).off('keydown.entity').on('keydown.entity', function(e){
      var isEnter = (e.key === 'Enter' || e.keyCode === 13);
      var isSpace = (e.key === ' ' || e.key === 'Spacebar' || e.keyCode === 32);
      var isTab = (e.key === 'Tab' || e.keyCode === 9);
      if (!isEnter && !isSpace && !isTab) return;
      var $active = $(document.activeElement);

      // native select
      if ($active.is('select')) {
        var val = $active.val();
        if (val === '__create_position__') { e.preventDefault(); showModal('#modalCreatePosition'); clearSelectValue($active); return; }
        if (val === '__create_department__') { e.preventDefault(); showModal('#modalCreateDepartment'); clearSelectValue($active); return; }
        if (val === '__create_marital_status__') { e.preventDefault(); showModal('#modalCreateMaritalStatus'); clearSelectValue($active); return; }
      }

      // selectize control
      var $ctrl = $active.closest('.selectize-control');
      if ($ctrl.length) {
        var $dropdown = $ctrl.find('.selectize-dropdown');
        var $highlight = $dropdown.find('.option.active, .option.highlighted').first();
        var hVal = $highlight.length ? $highlight.attr('data-value') : null;
        var $origSelect = $ctrl.prev('select');
        var origVal = $origSelect.length ? $origSelect.val() : null;
        if (hVal === '__create_position__' || origVal === '__create_position__') { e.preventDefault(); showModal('#modalCreatePosition'); try { if (posInst) { posInst.clear(); posInst.close(); posInst.focus(); } } catch(_) {} if ($origSelect.length) clearSelectValue($origSelect); return; }
        if (hVal === '__create_department__' || origVal === '__create_department__') { e.preventDefault(); showModal('#modalCreateDepartment'); try { if (depInst) { depInst.clear(); depInst.close(); depInst.focus(); } } catch(_) {} if ($origSelect.length) clearSelectValue($origSelect); return; }
        if (hVal === '__create_marital_status__' || origVal === '__create_marital_status__') { e.preventDefault(); showModal('#modalCreateMaritalStatus'); try { if (maritalInst) { maritalInst.clear(); maritalInst.close(); maritalInst.focus(); } } catch(_) {} if ($origSelect.length) clearSelectValue($origSelect); return; }
      }

      var $inDropdown = $active.closest('.selectize-dropdown');
      if ($inDropdown.length) {
        var $h = $inDropdown.find('.option.active, .option.highlighted').first();
        var valh = $h.length ? $h.attr('data-value') : null;
        if (valh === '__create_position__') { e.preventDefault(); showModal('#modalCreatePosition'); clearSelectValue($('#position')); return; }
        if (valh === '__create_department__') { e.preventDefault(); showModal('#modalCreateDepartment'); clearSelectValue($('#department')); return; }
        if (valh === '__create_marital_status__') { e.preventDefault(); showModal('#modalCreateMaritalStatus'); clearSelectValue($('#marital_status')); return; }
      }
    });

    // modal focus UX
    $(document).off('shown.bs.modal.entity').on('shown.bs.modal.entity', '#modalCreatePosition', function(){ $('#create_position_name').trigger('focus'); });
    $(document).off('shown.bs.modal.entity').on('shown.bs.modal.entity', '#modalCreateDepartment', function(){ $('#create_department_name').trigger('focus'); });
    $(document).off('shown.bs.modal.entity').on('shown.bs.modal.entity', '#modalCreateMaritalStatus', function(){ $('#create_marital_status_name').trigger('focus'); });

    // reinit helper for selectize
    window.reinitPositionDepartmentSelectize = function() {
      try { posInst = initSelectizeIfNeeded('#position', 'Select position'); } catch(e) { console.warn(e); }
      try { depInst = initSelectizeIfNeeded('#department', 'Select department'); } catch(e) { console.warn(e); }
      try { maritalInst = initSelectizeIfNeeded('#marital_status', 'Select marital status'); } catch(e) { console.warn(e); }
    };

    // global entity:edit listener (backwards-compatible).
    // If event payload contains 'entity', we map it directly to the right module.
    $(document).off('entity:edit.entity').on('entity:edit.entity', function(e, item){
      try {
        if (!item) return;
        // If entity provided and module exists, call module.startEdit and show modal
        if (item.entity && MODULES_BY_ENTITY[item.entity]) {
          var mod = MODULES_BY_ENTITY[item.entity];
          try { mod.startEdit(item); } catch(_) {}
          // open proper modal
          if (item.entity === 'position') showModal('#modalCreatePosition');
          else if (item.entity === 'department') showModal('#modalCreateDepartment');
          else if (item.entity === 'marital_status') showModal('#modalCreateMaritalStatus');
          return;
        }
        // fallback: older behavior — try to detect from DOM rows
        if ($('#positionList').find('.list-row[data-id="'+String(item.id)+'"]').length) {
          var $r = $('#positionList').find('.list-row[data-id="'+String(item.id)+'"]').first();
          var cur = { id: $r.attr('data-id'), name: $r.attr('data-name') || $r.find('.title').text(), code: $r.attr('data-code') || $r.find('.meta').text().replace(/^Code:\s*/, '') };
          positionModule.startEdit(cur);
          showModal('#modalCreatePosition');
          return;
        }
        if ($('#departmentList').find('.list-row[data-id="'+String(item.id)+'"]').length) {
          var $r2 = $('#departmentList').find('.list-row[data-id="'+String(item.id)+'"]').first();
          var cur2 = { id: $r2.attr('data-id'), name: $r2.attr('data-name') || $r2.find('.title').text(), code: $r2.attr('data-code') || $r2.find('.meta').text().replace(/^Code:\s*/, '') };
          departmentModule.startEdit(cur2);
          showModal('#modalCreateDepartment');
          return;
        }
        if ($('#maritalStatusList').find('.list-row[data-id="'+String(item.id)+'"]').length) {
          var $r3 = $('#maritalStatusList').find('.list-row[data-id="'+String(item.id)+'"]').first();
          var cur3 = { id: $r3.attr('data-id'), name: $r3.attr('data-name') || $r3.find('.title').text(), code: $r3.attr('data-code') || $r3.find('.meta').text().replace(/^Code:\s*/, '') };
          maritalStatusModule.startEdit(cur3);
          showModal('#modalCreateMaritalStatus');
          return;
        }
      } catch(e) { console.warn('entity:edit handler', e); }
    });

    // --- initial list loads (avoid permanent "Loading…") ---
    setTimeout(function(){
      try { positionModule.loadList(''); } catch(e){}
      try { departmentModule.loadList(''); } catch(e){}
      try { maritalStatusModule.loadList(''); } catch(e){}
    }, 20);

    // expose modules for debugging if needed
    window._employeeModules = MODULES_BY_ENTITY;

  }); // ready
})(jQuery);
</script>
  




<div class="modal fade" id="employeeSuccessModal" tabindex="-1" role="dialog" aria-labelledby="employeeSuccessModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeSuccessModalLabel">Employee Updated successfully</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">

        {% if updated_employee_name %}
          <div class="mt-2"><strong>Employee:</strong> {{ updated_employee_name }}</div>
        {% endif %}
      </div>

      <div class="modal-footer">
        <a href="{% url 'employee:employee_list' %}" class="btn btn-secondary" id="employeeSuccessBack">Go to Employee List</a>

        <button type="button" class="btn btn-primary" data-dismiss="modal" id="employeeSuccessOk">Okay</button>
      </div>
    </div>
  </div>
</div>

{% if show_success_modal %}

<script>
(function($){
  $(function(){
    // small helper to remove query params (URL API preferred, fallback to regex)
    function removeQueryParams(names) {
      try {
        if (window.history && window.history.replaceState && typeof URL === 'function') {
          var url = new URL(window.location.href);
          names.forEach(function(p){ url.searchParams.delete(p); });
          var newSearch = url.searchParams.toString();
          var newUrl = url.pathname + (newSearch ? ('?' + newSearch) : '') + (url.hash || '');
          window.history.replaceState({}, document.title, newUrl);
          return;
        }
      } catch (err) {
        // continue to fallback
      }

      // fallback: naive removal (keeps other params)
      try {
        var href = window.location.href;
        names.forEach(function(p){
          var re = new RegExp('([?&])' + p + '=[^&]*(&|$)', 'i');
          href = href.replace(re, function(m,g1,g2){ return g2 === '&' ? g1 : ''; });
        });
        href = href.replace(/[?&]$/, '');
        try { window.history.replaceState({}, document.title, href); } catch(e) { /* ignore */ }
      } catch (err) { /* ignore */ }
    }

    // show modal once on page load
    setTimeout(function(){
      try {
        if ($.fn.modal) {
          $('#employeeSuccessModal').modal({ backdrop: 'static', keyboard: true, show: true });
        } else {
          $('#employeeSuccessModal').modal('show');
        }
      } catch (e) {
        try { $('#employeeSuccessModal').modal('show'); } catch (ee) { console.warn('Modal show failed', ee); }
      }

      // remove trigger params so refresh won't re-open modal
      removeQueryParams(['updated', 'employee_name', 'emp_updated']);
    }, 80);

    // focus the OK button for keyboard users
    $('#employeeSuccessModal').on('shown.bs.modal', function () {
      try { $('#employeeSuccessOk').focus(); } catch (e) {}
    });
  });
})(jQuery);
</script>
{% endif %}


<script>
  function convertLogTimestampsToLocal() {
  document.querySelectorAll('.log-timestamp').forEach(el => {
    const raw = el.dataset.utc && el.dataset.utc.trim();

    if (!raw) return;

    // Convert "2025-10-14 07:52:38" to ISO UTC string "2025-10-14T07:52:38Z"
    const isoUtcString = raw.replace(" ", "T") + "Z";

    const date = new Date(isoUtcString);

    if (isNaN(date.getTime())) {
      el.textContent = '⚠️ Invalid date';
    } else {
      el.textContent = date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });
    }
  });
}
convertLogTimestampsToLocal()
</script>


<script>
(function ($) {
  $(function () {

    // ---------- ELEMENTS ----------
    var $form = $('#employeeForm');
    if (!$form.length) { console.error('employeeForm not found'); return; }

    var $email = $('#email'), $employeeId = $('#employeeId');
    var $file = $('#employee-image-upload');
    var $previewImg = $('#previewImg');
    var $avatarText = $('#avatarText');
    var $removeBtn = $('#removeImageBtn');

    // ---------- CSRF ----------
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    // ---------- Tabs ----------
    function activateTab(tabBtn) {
      var id = $(tabBtn).attr('id');
      if (!id) return;
      var panelId = id.replace(/^tab-/, 'panel-');
      $('.panel-section').hide().attr('aria-hidden', 'true');
      $('#' + panelId).show().attr('aria-hidden', 'false');
      $('.tab-btn').removeClass('active').attr('aria-selected', 'false');
      $(tabBtn).addClass('active').attr('aria-selected', 'true');
    }

    $(document).on('click', '.tab-btn', function (e) {
      e.preventDefault();
      activateTab(this);
    });

    // Initialize first tab
    (function () {
      var $initial = $('.tab-btn.active').first();
      if ($initial.length) activateTab($initial);
      else activateTab($('.tab-btn').first());
    })();

    // ---------- Image preview ----------
    function resetAvatarPreview() {
      try { $file.val(''); if ($file.prop('files')) $file[0].value = null; } catch (e) { }
      if ($previewImg.length) $previewImg.attr('src', '').addClass('hidden');
      if ($avatarText.length) $avatarText.show();
    }

    if ($file.length) {
      $file.on('change', function () {
        var f = this.files && this.files[0];
        if (!f) { resetAvatarPreview(); return; }

        var ext = (f.name || '').toLowerCase().split('.').pop();
        // var allowed = ['jpg', 'jpeg', 'png', 'webp', 'gif'];
        // if ($.inArray(ext, allowed) === -1) {
        //   alert('Allowed image types: JPG, PNG, WEBP, GIF');
        //   resetAvatarPreview();
        //   return;
        // }
        // if (f.size && f.size > 2 * 1024 * 1024) {
        //   alert('Image must be 2 MB or smaller');
        //   resetAvatarPreview();
        //   return;
        // }

        var reader = new FileReader();
        reader.onload = function (evt) {
          if ($previewImg.length) $previewImg.attr('src', evt.target.result).removeClass('hidden');
          if ($avatarText.length) $avatarText.hide();
        };
        reader.onerror = function () {
          alert('Unable to read selected image');
          resetAvatarPreview();
        };
        reader.readAsDataURL(f);
      });

      if ($removeBtn.length) {
        $removeBtn.on('click', function (e) {
          e.preventDefault();
          resetAvatarPreview();
        });
      }
    }

    // ---------- DOB max ----------
    (function () {
      var d = new Date();
      var yyyy = d.getFullYear(), mm = String(d.getMonth() + 1).padStart(2, '0'), dd = String(d.getDate()).padStart(2, '0');
      $('#dateOfBirth').attr('max', yyyy + '-' + mm + '-' + dd);
    })();

    // ---------- Remote uniqueness checks ----------
    function ajaxPostJson(url, payload) {
      return $.ajax({
        url: url,
        method: 'POST',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(payload),
        dataType: 'json',
        beforeSend: function (xhr) {
          if (csrftoken) xhr.setRequestHeader('X-CSRFToken', csrftoken);
        }
      });
    }

    function remoteCheckEmail(email) {
      if (!window.CHECK_EMAIL_URL) return Promise.resolve({ valid: true });
      return ajaxPostJson(window.CHECK_EMAIL_URL, { email: email })
        .then(res => ({ valid: !res.exists, message: res.message || 'Email already exists' }))
        .catch(() => ({ valid: true }));
    }

    function remoteCheckEmployeeId(empId) {
      if (!window.CHECK_EMPLOYEE_ID_URL) return Promise.resolve({ valid: true });
      return ajaxPostJson(window.CHECK_EMPLOYEE_ID_URL, { employee_id: empId })
        .then(res => ({ valid: !res.exists, message: res.message || 'Employee ID already exists' }))
        .catch(() => ({ valid: true }));
    }

    // ---------- Submit with validation ----------
    $form.on('submit', function (e) {
      e.preventDefault();

      function validateSelectizeField($select) {
        var value = $select.val();
        var $input = $select.next('.selectize-control').find('.selectize-input');
        if (!value) {
          $select.addClass('is-invalid');
          $input.addClass('is-invalid');
          return false;
        } else {
          $select.removeClass('is-invalid');
          $input.removeClass('is-invalid');
          return true;
        }
      }

      var validPosition = validateSelectizeField($('#position'));
      var validDepartment = validateSelectizeField($('#department'));
      // var validMaritalStatus = validateSelectizeField($('#maritalStatus'));
      var validGender = validateSelectizeField($('#gender')); 
      // var validDistrict = validateSelectizeField($('#district'));
      // var validState = validateSelectizeField($('#state'));
      // var validCountry = validateSelectizeField($('#country'));
$(function () {
  // Real-time validation for text inputs
  $('#id_name, #id_address, #id_code').on('input', function () {
    validateTextField($(this));
  });

  $('#id_mobile').on('input', function () {
    validateBalanceField($(this));
  });

  $('#id_pincode').on('input', function () {
    validatePincodeField($(this));
  });

  $('#id_gst').on('input', function () {
    validateGstField($(this));
  });

  // Real-time validation for selectize dropdowns
  ['#id_position', '#id_department', '#id_gender', '#id_country', '#id_state', '#id_district'].forEach(function (selector) {
    const $select = $(selector);
    if ($select.length && $select[0].selectize) {
      $select[0].selectize.on('change', function () {
        validateSelectizeField($select);
      });
    }
  });

  // Optional: validate all selectize fields on form submit
});

      if (!validPosition || !validDepartment || !validGender ) {
        return false;
      }

      // If EmployeeFormValidator is present
      if (!window.EmployeeFormValidator || typeof window.EmployeeFormValidator.validateAll !== 'function') {
        $form.off('submit');
        $form.submit();
        return;
      }

      var ok = window.EmployeeFormValidator.validateAll();
      if (!ok) {
        var $first = $form.find('.is-invalid').first();
        if ($first.length) {
          var $panel = $first.closest('.panel-section');
          if ($panel.length) {
            $('.panel-section').hide();
            $panel.show();
            $('.tab-btn').removeClass('active');
            $('#tab-' + $panel.attr('id').replace('panel-', '')).addClass('active');
          }
          $('html,body').animate({ scrollTop: $first.offset().top - 90 }, 200, function () { $first.focus(); });
        }
        return false;
      }

      // Uniqueness checks
      var checks = [];
      var emailVal = ($email.val() || '').trim();
      var empVal = ($employeeId.val() || '').trim();
      if (emailVal) checks.push(remoteCheckEmail(emailVal).then(res => ({ field: 'email', res })));
      if (empVal) checks.push(remoteCheckEmployeeId(empVal).then(res => ({ field: 'employeeId', res })));

      if (checks.length === 0) {
        $form.off('submit');
        $form.submit();
        return false;
      }

      Promise.all(checks).then(results => {
        let blocked = false;
        results.forEach(item => {
          if (!item.res.valid) {
            window.EmployeeFormValidator.setError(item.field, item.res.message);
            blocked = true;
          } else {
            window.EmployeeFormValidator.clearError(item.field);
          }
        });
        if (!blocked) {
          $form.off('submit');
          $form.submit();
        } else {
          var $first = $form.find('.is-invalid').first();
          if ($first.length) {
            var $panel = $first.closest('.panel-section');
            if ($panel.length) {
              $('.panel-section').hide();
              $panel.show();
              $('.tab-btn').removeClass('active');
              $('#tab-' + $panel.attr('id').replace('panel-', '')).addClass('active');
            }
            $('html,body').animate({ scrollTop: $first.offset().top - 90 }, 200, function () { $first.focus(); });
          }
        }
      }).catch(err => {
        console.warn('Uniqueness check error, submitting anyway', err);
        $form.off('submit');
        $form.submit();
      });

      return false;
    });

  });
})(jQuery);
</script>
<script>
(function(window, $){
  if (!$) throw new Error('jQuery is required for EmployeeFormValidator');

  var EmployeeFormValidator = (function(){

    var cfg = {
      formSelector: '#employeeForm',
      invalidClass: 'is-invalid',
      errorNodeClass: 'validate-error',
      serverFieldErrorSelector: '.field-error' // server-rendered nodes
    };
    var $form = null;
    var touched = {};         // track which fields user has interacted with
    var formSubmitted = false;

    function ensureInlineErrorNode($control, name){
      name = name || ($control && ($control.attr('name') || $control.attr('id')));
      if (!name) return $('<small>');

      var $server = $form.find(cfg.serverFieldErrorSelector + '[data-error-for="'+name+'"]').first();
      if ($server.length) {
        $server.addClass(cfg.errorNodeClass).css({display:'block'}).attr('role','alert').attr('aria-live','polite');
        if (!$server.attr('id')) $server.attr('id','err-'+name);
        return $server;
      }

      var $fg = $control ? $control.closest('.form-group') : $();
      if ($fg.length) {
        var $node = $fg.find('small.'+cfg.errorNodeClass+'[data-for="'+name+'"]');
        if (!$node.length) {
          $node = $('<small class="'+cfg.errorNodeClass+' text-danger d-block" data-for="'+name+'"></small>');
          $fg.append($node);
        }
        $node.css({display:'block'}).attr('role','alert').attr('aria-live','polite');
        if (!$node.attr('id')) $node.attr('id','err-'+name);
        return $node;
      }

      var $node = $control && $control.length ? $control.next('small.'+cfg.errorNodeClass+'[data-for="'+name+'"]') : $();
      if (!$node.length) {
        $node = $('<small class="'+cfg.errorNodeClass+' text-danger d-block" data-for="'+name+'"></small>');
        if ($control && $control.length) $control.after($node); else $form.append($node);
      }
      $node.css({display:'block'}).attr('role','alert').attr('aria-live','polite');
      if (!$node.attr('id')) $node.attr('id','err-'+name);
      return $node;
    }

    // Set inline error + add invalid class to control and to Selectize wrapper (if present)
    function setError(name, msg){
      if (!name) return;
      var $ctrl = $form.find('[name="'+name+'"], #'+name).first();
      var $err = $form.find(cfg.serverFieldErrorSelector + '[data-error-for="'+name+'"]').first();
      if (!$err.length) $err = ensureInlineErrorNode($ctrl, name);

      try {
        $err.text(msg || '').removeClass('d-none').css({display:'block', visibility:'visible'});
      } catch(e) { console.warn('Failed to set inline error text node', e); }

      if ($ctrl.length) {
        $ctrl.addClass(cfg.invalidClass).attr('aria-invalid','true');
        try { $ctrl.attr('aria-describedby', $err.attr('id')); } catch(e){}
        // Selectize handling: the visible widget is a sibling '.selectize-control'
        try {
          var sel = $ctrl[0] && $ctrl[0].selectize;
          if (sel) {
            // selectize creates next('.selectize-control')
            var $wrap = $ctrl.next('.selectize-control');
            if (!$wrap.length && sel.$control) $wrap = sel.$control.parent(); // fallback
            if ($wrap && $wrap.length) {
              // highlight the input area inside selectize
              $wrap.find('.selectize-input').addClass(cfg.invalidClass).attr('aria-invalid','true').attr('aria-describedby', $err.attr('id'));
            }
          }
        } catch(e){ /* non-fatal */ }
      }
    }

    // Clear inline error + remove invalid class from control and Selectize wrapper
    function clearError(name){
      if (!name) return;
      var $ctrl = $form.find('[name="'+name+'"], #'+name).first();
      var $err = $form.find(cfg.serverFieldErrorSelector + '[data-error-for="'+name+'"], small.'+cfg.errorNodeClass+'[data-for="'+name+'"]');
      if ($err.length) $err.text('').css({display:'none', visibility:'hidden'});
      if ($ctrl.length) {
        $ctrl.removeClass(cfg.invalidClass).removeAttr('aria-invalid').removeAttr('aria-describedby');
        try {
          var sel = $ctrl[0] && $ctrl[0].selectize;
          if (sel) {
            var $wrap = $ctrl.next('.selectize-control');
            if (!$wrap.length && sel.$control) $wrap = sel.$control.parent();
            if ($wrap && $wrap.length) {
              $wrap.find('.selectize-input').removeClass(cfg.invalidClass).removeAttr('aria-invalid').removeAttr('aria-describedby');
            }
          }
        } catch(e){ /* ignore */ }
      }
    }

    function resetErrors(){
      $form.find(cfg.serverFieldErrorSelector + '[data-error-for]').each(function(){ $(this).text('').css({display:'none', visibility:'hidden'}); });
      $form.find('small.'+cfg.errorNodeClass+'[data-for]').each(function(){ $(this).text('').css({display:'none', visibility:'hidden'}); });
      $form.find('input,select,textarea').removeClass(cfg.invalidClass).removeAttr('aria-invalid').removeAttr('aria-describedby');
      // remove selectize highlight if any
      $form.find('.selectize-control .selectize-input.'+cfg.invalidClass).removeClass(cfg.invalidClass).removeAttr('aria-invalid').removeAttr('aria-describedby');
    }

    // validation rules (added 'type' rule)
    var rules = {
name: function($el){
    var v = ($el.val() || '').trim();
    if(!v) return 'Please enter full name';
    if(v.length > 200) return 'Name must be ≤ 200 chars';

    // ✅ allow only letters (A–Z, a–z) and spaces
    if(!/^[A-Za-z\s]+$/.test(v)) return 'Name must contain only letters and spaces';

    return null;
},      
   emgPhone: function($el) {
    var v = ($el.val() || '').trim();
    if (!v) return null;
    var c = v.replace(/[\s\-()+]/g, ''); // Remove non-digits (spaces, dashes, etc.)
    if (!/^\d{10}$/.test(c)) return 'Emergency phone number must be 10 digits';  // Ensure it's exactly 10 digits
    return null;
  },
    aadhaarNumber: function($el) {
    var v = ($el.val() || '').trim();  // Get the value of the field

    if (!v) return null;
    var cleanedValue = v.replace(/\D/g, '');

    if (!/^\d{12}$/.test(cleanedValue)) {
      return 'Aadhaar number must be exactly 12 digits';
    }

    return null;  // Return null if validation is successful
  },
email: function($el){ var v=($el.val()||'').trim(); 
      // if(!v) return 'Please enter email'; 
      if (v){
      var re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/; if(!re.test(v)) return 'Enter a valid email'; return null;
      }
     },
      mobile: function($el){ var v=($el.val()||'').trim(); if(!v) return 'Please enter mobile'; var c=v.replace(/[\s\-()+]/g,''); if(!/^\d{10}$/.test(c)) return 'Mobile number must be 10 digits'; return null; },
workEmail: function($el) {
  var v = ($el.val() || '').trim();
  if (!v) return null; // ✅ Allow empty
  var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!re.test(v)) return 'Enter a valid work email';
  return null;
},
workMobile: function($el) {
  var v = ($el.val() || '').trim();
  if (!v) return null; // ✅ Allow empty
  var c = v.replace(/[\s\-()+]/g, '');
  if (!/^\d{10}$/.test(c)) return 'Work mobile number must be 10 digits';
  return null;
},
workPhone: function($el) {
  var v = ($el.val() || '').trim();
  if (!v) return null; // ✅ Allow empty
  var c = v.replace(/[\s\-()+]/g, '');
  if (!/^\d{10}$/.test(c)) return 'Work phone number must be 10 digits';
  return null;
},     employeeId: function($el){ var v=($el.val()||'').trim(); if(!v) return 'Please enter employee ID'; return null; },
      // workLocation: function($el){ var v=($el.val()||'').trim(); if(!v) return 'Please enter work location'; return null; },
      address: function($el) {
        var v = ($el.val() || '').trim();
        // if (!v) return 'Please enter address';

        // Optional: limit max length
        if (v.length > 0) {
          if (v.length > 200) return 'Address must be 200 characters or less';

          // Optional: avoid addresses with only numbers or symbols
          if (!/[a-zA-Z]/.test(v)) return 'Address must contain letters';
        }


        return null;
      },
        city: function($el) {
        var v = ($el.val() || '').trim();

        // if (!v) return 'Please enter city';
        if (v.length > 100) return 'City must be ≤ 100 chars';

        // Reject if value contains only digits
        if (/^\d+$/.test(v)) return 'City name cannot be numbers only';

        // Optionally reject invalid characters (only letters, numbers, spaces, hyphens, etc.)
        // if (!/^[a-zA-Z0-9\s\-]+$/.test(v)) return 'City contains invalid characters';

        return null;
      },     
      pinCode: function($el){ var v=($el.val()||'').trim(); var c = (v||'').replace(/\s+/g,'');
      //  if(!c) return 'Please enter pin code'; 
      if (c.length >0){
       if(!/^\d{6}$/.test(c)) return 'Pin code must be 6 digits'; return null; 

      }
      },
      dateOfBirth: function($el){ var v=($el.val()||'').trim();
      //  if(!v) return 'Please enter date of birth'; 
      if (v){
       if(!/^\d{4}-\d{2}-\d{2}$/.test(v)) return 'Use YYYY-MM-DD'; return null; 

      }
      },
      maritalStatus: function($el){
        var selectize = $el[0] && $el[0].selectize;
        var v = selectize ? (String(selectize.getValue()||'').trim()) : String($el.val()||'').trim();
        // if (!v) return 'Please select marital status';
        return null;
      },
      position: function($el){
        var selectize = $el[0] && $el[0].selectize;
        var v = selectize ? (String(selectize.getValue()||'').trim()) : String($el.val()||'').trim();
        if (!v) return 'Please select position';
        return null;
      },
      department: function($el){
        var selectize = $el[0] && $el[0].selectize;
        var v = selectize ? (String(selectize.getValue()||'').trim()) : String($el.val()||'').trim();
        if (!v) return 'Please select department';
        return null;
      },
      // district : function($el){
      //   var selectize = $el[0] && $el[0].selectize;
      //   var v = selectize ? (String(selectize.getValue()||'').trim()) : String($el.val()||'').trim();
      //   if (!v) return 'Please select district';
      //   return null;
      // },
      gender: function($el){
        var selectize = $el[0] && $el[0].selectize;
        var v = selectize ? (String(selectize.getValue()||'').trim()) : String($el.val()||'').trim();
        if (!v) return 'Please select gender';
        return null;
      },

      // === NEW: Type field validation (name="type", id="employee_type") ===
      // ensures value exists and is one of allowed values
      type: function($el){
        var selectize = $el[0] && $el[0].selectize;
        var v = selectize ? (String(selectize.getValue()||'').trim()) : String($el.val()||'').trim();
        if (!v) return 'Please select Type';
        if (['limited','admin'].indexOf(v) === -1) return 'Invalid type selected';
        return null;
      },

      role: function($el){
        var selectize = $el[0] && $el[0].selectize;
        var v = selectize ? (String(selectize.getValue()||'').trim()) : String($el.val()||'').trim();
        if (!v) return 'Please select role';
        return null;
      },
      joiningDate: function($el){ var v=($el.val()||'').trim(); if(!v) return 'Please enter joining date'; if(!/^\d{4}-\d{2}-\d{2}$/.test(v)) return 'Use YYYY-MM-DD'; return null; },
      username: function($el) {
        var v = ($el.val() || '').trim();
        if (!v) return 'Please enter username';
        if (v.length < 3) return 'Username must be at least 3 characters';
        return null;
      },
password: function($el) {
  var v = ($el.val() || '').trim();

  // Allow empty (i.e., no password change)
  if (!v) return null;

  if (v.length < 6) return 'Password must be at least 6 characters';

  // Must contain at least one letter and one number
  if (!/[a-zA-Z]/.test(v) || !/[0-9]/.test(v)) {
    return 'Password must contain letters and numbers';
  }

  return null;
},

confirmPassword: function($el) {
  var v = ($el.val() || '').trim();
  var v2 = ($form.find('[name="password"]').val() || '').trim();

  // If password is empty, skip confirm validation
  if (!v2) return null;

  if (!v) return 'Please confirm password';
  if (v !== v2) return 'Passwords do not match';
  return null;
},


      // basicSalary: function($el){ var v=($el.val()||'').trim(); if(!v) return 'Please enter basic salary'; if(isNaN(Number(v)) || Number(v) < 0) return 'Enter a valid basic salary'; return null; },
      // da: function($el){ var v=($el.val()||'').trim(); if(!v) return 'Please enter DA'; if(isNaN(Number(v)) || Number(v) < 0) return 'Enter a valid DA'; return null; },
      // hra: function($el){ var v=($el.val()||'').trim(); if(!v) return 'Please enter HRA'; if(isNaN(Number(v)) || Number(v) < 0) return 'Enter a valid HRA'; return null; }
    };

    function init(options){
      options = options || {};
      cfg.formSelector = options.formSelector || cfg.formSelector;
      $form = $(cfg.formSelector);
      if (!$form.length) { console.warn('EmployeeFormValidator: form not found for selector', cfg.formSelector); return; }

      // mark fields that already have server-rendered messages as touched
      $form.find(cfg.serverFieldErrorSelector + '[data-error-for]').each(function(){
        var $n = $(this), name = $n.data('error-for');
        if (!name) return;
        try {
          var txt = $n.text() || '';
          if (txt.trim()) {
            touched[name] = true;
            setError(name, txt.trim());
          }
        } catch(e){ console.warn('Error while marking touched fields.', e); }
      });

      // live validation: only validate if field is touched (or after submit)
      $form.on('input change', 'input,textarea,select', debounce(function(e){
        var $t = $(e.target); var name = $t.attr('name') || $t.attr('id'); if(!name) return;
        if (!touched[name] && !formSubmitted) return;
        if (rules[name]) {
          validateField(name);
        } else {
          var label = ($form.find('label[for="'+($t.attr('id')||'')+'"]').text()||'');
          if (label.indexOf('*') !== -1) {
            if (($t.val()||'').toString().trim()==='') setError(name, 'Please enter '+label.replace('*','').trim());
            else clearError(name);
          } else {
            clearError(name);
          }
        }
      }, 150));

      // Defensive submit handler:
      $form.off('submit.employeeValidator').on('submit.employeeValidator', function(e){
        formSubmitted = true;

        try {
          if ($form[0] && typeof $form[0].checkValidity === 'function' && !$form[0].checkValidity()) {
            $form.addClass('was-validated');
            validateAll();
            e.preventDefault(); e.stopImmediatePropagation();
            var $firstInv = $form.find('.'+cfg.invalidClass).first();
            if ($firstInv && $firstInv.length) try { $firstInv.focus(); } catch(_) {}
            return false;
          }
        } catch (err) {
          // ignore and continue
        }

        var ok = validateAll();
        if (!ok) {
          e.preventDefault();
          e.stopImmediatePropagation();
          var $first = $form.find('.' + cfg.invalidClass).first();
          if ($first && $first.length) try { $first.focus(); } catch(_) {}
          return false;
        }

        try {
          $form.find('button[type="submit"], input[type="submit"]').prop('disabled', true).addClass('disabled');
        } catch (err) { /* ignore */ }

        return true;
      });
    }

    function validateField(name){
      var $el = $form.find('[name="'+name+'"], #'+name).first();
      if (!$el.length) return true;
      var fn = rules[name];
      if (typeof fn === 'function'){
        var msg = fn($el);
        if (msg) { setError(name, msg); return false; }
        clearError(name); return true;
      }
      return true;
    }

    function validateAll(){
      if (!$form || !$form.length) return true;
      var ok = true;
      Object.keys(rules).forEach(function(name){
        touched[name] = true;
        if (!validateField(name)) ok = false;
      });
      return ok;
    }

    function debounce(fn, wait){ var t; return function(){ var ctx=this,args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, wait||200); }; }

    return {
      init: init,
      validateField: validateField,
      validateAll: validateAll,
      resetErrors: resetErrors,
      setError: setError,
      clearError: clearError
    };
  })();

  window.EmployeeFormValidator = EmployeeFormValidator;

  // Auto-init on DOM ready
  $(function(){ if (window.EmployeeFormValidator) window.EmployeeFormValidator.init({ formSelector:'#employeeForm' }); });

})(window, window.jQuery);
</script>


  

<!-- <script>
  document.addEventListener('DOMContentLoaded', function () {
    const fileInput = document.getElementById('employee-image-upload');
    const previewImg = document.getElementById('previewImg');
    const avatarText = document.getElementById('avatarText');
    const removeBtn = document.getElementById('removeImageBtn');
    const removeFlag = document.getElementById('remove_image');

    function showPreview(url) {
        if (!previewImg) return;
        previewImg.src = url || '';
        if (url) {
            previewImg.classList.remove('hidden');
            if (avatarText) avatarText.style.display = 'none';
        } else {
            previewImg.classList.add('hidden');
            if (avatarText) avatarText.style.display = '';
        }
    }

    // initialize (if template set an src, it will already show; this ensures display state)
    if (previewImg && previewImg.src && previewImg.getAttribute('src') !== '') {
        // previewImg.src may be absolute - ensure UI reflects it
        showPreview(previewImg.src);
    } else {
        showPreview(null);
    }

    // when user selects a new file, preview it and clear the remove flag
    if (fileInput) {
        fileInput.addEventListener('change', function (ev) {
            const file = ev.target.files && ev.target.files[0];
            if (!file) {
                // nothing selected
                return;
            }
            // show preview using object URL
            const url = URL.createObjectURL(file);
            showPreview(url);
            // clear any "remove" request
            if (removeFlag) removeFlag.value = '0';
            // optionally revoke the objectURL after load to free memory
            previewImg.onload = function () {
                URL.revokeObjectURL(url);
            };
        });
    }

    // Remove button: clear preview, clear the file input, set remove flag
    if (removeBtn) {
        removeBtn.addEventListener('click', function (ev) {
            ev.preventDefault();
            // clear file input
            if (fileInput) {
                try {
                    fileInput.value = '';
                } catch (e) {
                    // some browsers restrict direct clearing; replace input as fallback
                    const parent = fileInput.parentNode;
                    const newInput = fileInput.cloneNode(true);
                    parent.replaceChild(newInput, fileInput);
                    // re-bind change handler to the new input if needed (left as exercise)
                }
            }
            // hide preview and show placeholder text
            showPreview(null);
            // notify server to remove existing image on submit
            if (removeFlag) removeFlag.value = '1';
        });
    }
});

  </script> -->
  

<script>
$(document).ready(function() {
  $('#gender').selectize({
    placeholder: 'Select Gender',
    allowEmptyOption: true,
    plugins: ['clear_button'],
  });
    $('#branch').selectize({
    placeholder: 'Select Branch',
    allowEmptyOption: true,
    plugins: ['clear_button'],

  });
    $('#manager').selectize({
    placeholder: 'Select Manager',
    allowEmptyOption: true,
    plugins: ['clear_button'],
  });
    $('#position').selectize({
    placeholder: 'Select Position',
    allowEmptyOption: true,
    plugins: ['clear_button']
  });
    $('#department').selectize({
    placeholder: 'Select Department',
    allowEmptyOption: true,
    plugins: ['clear_button']
  });
    $('#maritalStatus').selectize({
    placeholder: 'Select Marital Status',
    allowEmptyOption: true,
    plugins: ['clear_button']
  });
  $('#lco').selectize({
      placeholder: 'Select LCO',
      allowEmptyOption: true,
      plugins: ['clear_button'],
      searchField: ['text'],
      // keep closeAfterSelect true for single selects
      closeAfterSelect: true
    });
    $('#employee_type').selectize({
  placeholder: 'Select Type',
  allowEmptyOption: true,
  plugins: ['clear_button'],
  searchField: ['text'],
  onChange: function(value) {
    // keep server-side validation visuals in sync
    var $s = $('#employee_type');
    if (value) $s.removeClass('is-invalid'); 
    $s.trigger('change');
  }
});
  $('#allowed_branches').selectize({
  plugins: ['remove_button'],
  placeholder: 'Select allowed branches',
  allowEmptyOption: true,
  dropdownParent: 'body',
  searchField: ['text'],
});

});
$(document).ready(function () {
  // -------------------------------
  // Setup
  // -------------------------------
  const countrySelect = document.getElementById('country');
  const stateSelect = document.getElementById('state');
  const districtSelect = document.getElementById('district');

  // Use let for pre-selected variables as they will be modified (cleared)
  let preSelectedCountry = (countrySelect.getAttribute('data-selected') || '').trim().toLowerCase();
  let preSelectedState = (stateSelect.getAttribute('data-selected') || '').trim().toLowerCase();
  let preSelectedDistrict = (districtSelect.getAttribute('data-selected') || '').trim().toLowerCase();

  // console.log("Preselected Values:", preSelectedCountry, preSelectedState, preSelectedDistrict);

  let countriesData = [];
  // isProgrammaticChange must be globally accessible to handlers and listeners
  let isProgrammaticChange = false; 

  // -------------------------------
  // Initialize Selectize controls (No change here)
  // -------------------------------
  const $selectCountry = $('#country').selectize({
    valueField: 'value',
    labelField: 'text',
    searchField: 'text',
    placeholder: "Select Country",
    allowEmptyOption: true,
    plugins: ['clear_button'],
  });

  const $selectState = $('#state').selectize({
    valueField: 'value',
    labelField: 'text',
    searchField: 'text',
    placeholder: "Select State",
    allowEmptyOption: true,
    plugins: ['clear_button'],
    disabled: true
  });

  const $selectDistrict = $('#district').selectize({
    valueField: 'value',
    labelField: 'text',
    searchField: 'text',
    placeholder: "Select District",
    allowEmptyOption: true,
    plugins: ['clear_button'],
    disabled: true
  });

  const selectizeCountry = $selectCountry[0].selectize;
  const selectizeState = $selectState[0].selectize;
  const selectizeDistrict = $selectDistrict[0].selectize;

  // -------------------------------
  // Helpers
  // -------------------------------
  function disableDistrict() {
    selectizeDistrict.clearOptions();
    selectizeDistrict.clear();
    selectizeDistrict.disable();
  }

  // -------------------------------
  // Load Countries
  // -------------------------------
  $.getJSON("{% static 'data/countries+states+cities.json' %}", function (countries) {
    countriesData = countries;

    countries.forEach(function (country) {
      selectizeCountry.addOption({
        value: country.name.toLowerCase(), // store value lowercase
        text: country.name,
        states: country.states
      });
    });

    selectizeCountry.refreshOptions(false);

    // Preselect country if available
    if (preSelectedCountry) {
      selectizeCountry.setValue(preSelectedCountry.toLowerCase());
      handleCountryChange(preSelectedCountry.toLowerCase());
    }
  });


  // -------------------------------
  // Handlers
  // -------------------------------
  function handleCountryChange(countryValue) {
    selectizeState.clearOptions();
    selectizeState.clear();
    selectizeState.disable();
    disableDistrict();

    if (!countryValue) return;

    var selectedCountry = countriesData.find(c => c.name.toLowerCase() === countryValue);
    if (!selectedCountry || !selectedCountry.states) return;

    selectedCountry.states.forEach(function (state) {
      selectizeState.addOption({
        value: state.name.toLowerCase(), // lowercase
        text: state.name
      });
    });

    selectizeState.refreshOptions(false);
    selectizeState.enable();

    // Preselect state if applicable
    if (preSelectedState) {
      selectizeState.setValue(preSelectedState.toLowerCase());
      handleStateChange(preSelectedState.toLowerCase());
      preSelectedState = '';
    }
  }

  function handleStateChange(stateValue) {
    if (!stateValue) {
      disableDistrict();
      return;
    }

    // FIX 3: Clear and disable outside of the async call
    selectizeDistrict.clearOptions();
    selectizeDistrict.clear();
    selectizeDistrict.disable();
    
    // We *must* check the flag here to prevent manual changes from seeing stale preSelectedDistrict
    const shouldPreselect = preSelectedDistrict && !isProgrammaticChange; 
    
    // Check if the variable was cleared by the first run
    // console.log('preeee', shouldPreselect ? preSelectedDistrict : '', 'as');

    loadDistrictsFromAPI(stateValue, function (districts) {
      if (districts.length) {
        selectizeDistrict.enable();
        selectizeDistrict.addOption(districts);
        selectizeDistrict.refreshOptions(false);
        
        // console.log("DEBUG:", { preSelectedDistrict, loadedDistricts: districts });

        // FIX 4: Use the shouldPreselect flag from the top of the function
        if (shouldPreselect) { 
          const match = districts.find(d => d.value === preSelectedDistrict);
          if (match) {
            // Use the programmatic flag to suppress any change event caused by setValue
            isProgrammaticChange = true; 
            selectizeDistrict.setValue(match.value);
            // 💡 Include the refreshItems fix just in case of rendering glitch
            selectizeDistrict.refreshItems(); 
            isProgrammaticChange = false;

            // console.log("✅ Preselected district applied:", match.value);
          }
          
          // Clear the flag ONLY if we successfully found and set the value
          preSelectedDistrict = '';
        }
      }
    });
  }

  // -------------------------------
  // Event Listeners (Use the flag to block programmatic changes)
  // -------------------------------
  selectizeCountry.on('change', function (value) {
    if (isProgrammaticChange) return;
    handleCountryChange(value);
  });

  selectizeState.on('change', function (value) {
    if (isProgrammaticChange) return;
    // CRITICAL: A manual state change means we should re-enable preselection logic
    // but since this is a user change, preSelectedDistrict should be ignored anyway.
    handleStateChange(value);
  });

  // -------------------------------
  // AJAX for Districts (No change needed here)
  // -------------------------------
  function loadDistrictsFromAPI(stateName, callback) {
    $.ajax({
      url: "/static/data/districts.json",
      method: "GET",
      dataType: "json"
    })
      .done(function (res) {
        if (!Array.isArray(res)) return callback([]);

        const filtered = res.filter(
          d => d.state_name.trim().toLowerCase() === stateName.trim().toLowerCase()
        );

        const districts = filtered.map(d => ({
          value: d.name.toLowerCase(),
          text: d.name
        }));

        callback(districts);
      })
      .fail(function () {
        callback([]);
      });
  }
});

</script>

<script>
(function($){
  // watches position/department modals and fires their list loader when shown
  $(function(){

    function tryLoadByModuleOrSearch(moduleName, searchSelector){
      try {
        // 1) If the module is exposed on window, call its loadList('')
        if (window[moduleName] && typeof window[moduleName].loadList === 'function') {
          try { window[moduleName].loadList(''); return true; } catch(e){ console.warn(moduleName + '.loadList failed', e); }
        }

        // 2) Fallback: trigger the search input's input event (your module binds to this)
        var $s = $(searchSelector);
        if ($s.length) {
          // clear and trigger so the debounce handler will call loadList('')
          try { $s.val(''); $s.trigger('input'); return true; } catch(e){ console.warn('triggering search input failed', e); }
        }

        // 3) Nothing to do
        return false;
      } catch(e){
        console.error('tryLoadByModuleOrSearch error', e);
        return false;
      }
    }

    function watchModal(modalSelector, moduleName, searchSelector){
      var el = document.querySelector(modalSelector);
      if (!el) return;

      var fired = false;

      // Called when we detect the modal is opening
      function fireOnce(){
        if (fired) return;
        fired = true;
        // small delay to let bootstrap finish showing & painting
        setTimeout(function(){
          tryLoadByModuleOrSearch(moduleName, searchSelector);
        }, 40);
      }

      // reset when closed
      function reset(){
        fired = false;
      }

      // Bootstrap events (preferred)
      try {
        $(el).on('show.bs.modal shown.bs.modal', function(){ fireOnce(); });
        $(el).on('hide.bs.modal hidden.bs.modal', function(){ reset(); });
      } catch(e){ /* ignore if bootstrap not present */ }

      // MutationObserver fallback (observes class/style changes)
      try {
        var mo = new MutationObserver(function(muts){
          var isShown = el.classList && el.classList.contains('show') || (window.getComputedStyle(el).display !== 'none' && el.offsetParent !== null);
          if (isShown) fireOnce(); else reset();
        });
        mo.observe(el, { attributes: true, attributeFilter: ['class', 'style', 'aria-hidden'] });
      } catch(e){ /* ignore in old browsers */ }
    }

    // attach watchers (if the elements exist now)
    watchModal('#modalCreatePosition', 'positionModule', '#positionListSearch');
    watchModal('#modalCreateDepartment', 'departmentModule', '#departmentListSearch');

    // If modals are injected later, attempt to attach until they exist (stop after 10 attempts)
    var tries = 0;
    var iv = setInterval(function(){
      tries += 1;
      if (document.querySelector('#modalCreatePosition') && !document.querySelector('#modalCreatePosition').__watched) {
        watchModal('#modalCreatePosition', 'positionModule', '#positionListSearch');
        document.querySelector('#modalCreatePosition').__watched = true;
      }
      if (document.querySelector('#modalCreateDepartment') && !document.querySelector('#modalCreateDepartment').__watched) {
        watchModal('#modalCreateDepartment', 'departmentModule', '#departmentListSearch');
        document.querySelector('#modalCreateDepartment').__watched = true;
      }
      if ((document.querySelector('#modalCreatePosition') && document.querySelector('#modalCreateDepartment')) || tries > 10) {
        clearInterval(iv);
      }
    }, 200);

  });
})(jQuery);
</script>








{% endblock %}
